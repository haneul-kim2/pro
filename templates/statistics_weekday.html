<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>요일별 요약 통계</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 스타일은 이전 답변과 동일하게 유지 (필요시 style.css로 이동) */
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; color: #333; display: flex; flex-direction: column; min-height: 100vh; }
        header { background: #333; color: #fff; padding: 1rem 0; text-align: center; }
        header h1 { margin: 0; font-size: 1.8rem; }
        nav { background: #444; padding: 0.5rem 0; }
        nav ul { padding: 0; list-style: none; text-align: center; margin: 0; }
        nav ul li { display: inline-block; margin: 0 5px; }
        nav ul li a { text-decoration: none; color: #fff; padding: 10px 15px; display: inline-block; border-radius: 4px; transition: background-color 0.3s ease; }
        nav ul li a:hover, nav ul li a.active { background-color: #555; }
        main.container { flex-grow: 1; width: 90%; max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px; }
        footer { background: #333; color: #fff; text-align: center; padding: 1rem 0; margin-top: auto; width: 100%; }
        nav ul li.dropdown { position: relative; display: inline-block; }
        nav ul li.dropdown .dropbtn { cursor: default; }
        nav ul li.dropdown .dropdown-content { display: none; position: absolute; background-color: #444; min-width: 120px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; left: 0; border-radius: 0 0 4px 4px; overflow: hidden; }
        nav ul li.dropdown .dropdown-content a { color: white; padding: 10px 15px; text-decoration: none; display: block; text-align: left; white-space: nowrap; }
        nav ul li.dropdown .dropdown-content a:hover { background-color: #555; }
        nav ul li.dropdown:hover .dropdown-content { display: block; }
        h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; margin-bottom: 20px; }
        .filters { background-color: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; border: 1px solid #eee;}
        .filters label { font-weight: bold; margin-right: 5px; color: #555; }
        .filters input[type="date"], .filters select, .filters input[type="radio"] { margin-right: 5px; vertical-align: middle; }
        .filters input[type="radio"] + label { font-weight: normal; margin-right: 15px; }
        .filters select, .filters input[type="date"] { padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; }
        .filters button { background-color: #5bc0de; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; }
        .filters button:hover { background-color: #31b0d5; }
        .chart-container { position: relative; height: 40vh; width: 100%; margin-bottom: 30px; }
        #weekdayChart { border: 1px solid #eee; border-radius: 5px; background-color: #fff; padding: 10px; }
        .avg-summary { background-color: #eef; padding: 15px; border-radius: 5px; margin-top: 20px; border: 1px solid #ddf; font-size: 0.95rem; }
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #e0e0e0; padding: 10px 12px; text-align: left; vertical-align: middle; font-size: 0.9rem; }
        th { background-color: #f8f8f8; font-weight: bold; color: #333; text-transform: uppercase; font-size: 0.85rem; }
        tbody tr:nth-child(even) { background-color: #fdfdfd; }
        tbody tr:hover { background-color: #f0f0f0; }
        td { color: #555; }
        td:not(:first-child) { text-align: right; }
        .message-area { padding: 15px; margin-bottom: 20px; border-radius: 4px; border: 1px solid transparent; }
        .message-area.error { background-color: #f2dede; color: #a94442; border-color: #ebccd1; }
        .message-area:empty { display: none; }
    </style>
</head>
<body>
    <header>
        <h1>메이플스토리 수익 기록 웹</h1>
    </header>

   <!-- 네비게이션 바 - 순서 및 이름 변경 -->
 <!-- 네비게이션 바 - 순서 및 이름 변경 -->
<nav>
    <ul>
        <!-- 1. 홈 -->
        <li><a href="{{ url_for('home') }}">홈</a></li> <!-- 'active' 클래스는 페이지별로 다를 수 있으니 일단 빼고 복사하거나, 나중에 각 페이지에 맞게 수정 -->

        <!-- 2. 사냥 -->
        <li><a href="{{ url_for('list_and_add_hunting_sessions') }}">사냥</a></li>

        <!-- 3. 쩔 -->
        <li><a href="{{ url_for('list_and_add_jjul_sessions') }}">쩔</a></li>

        <!-- 4. 경험치 통계 (신규 추가) -->
        <li><a href="{{ url_for('statistics_experience') }}">경험치 통계</a></li>

        <!-- 5. 통계 (드롭다운) -->
        <li class="dropdown">
            <a href="javascript:void(0)" class="dropbtn">통계</a>
            <div class="dropdown-content">
                <a href="{{url_for('statistics_daily') }}">일별 요약</a>
                <a href="{{ url_for('statistics_map') }}">맵별 요약</a>
                <a href="{{ url_for('statistics_weekday') }}">요일별 요약</a>
            </div>
        </li>

        <!-- 6. 메소 판매 기록 (이름 변경) -->
        <li><a href="{{ url_for('list_and_add_meso_sales') }}">메소 판매 기록</a></li>
    </ul>
</nav>
    <!-- 네비게이션 바 끝 -->
    <!-- 네비게이션 바 끝 -->

    <main class="container">
        <h2>요일별 요약 통계</h2>
        <div id="message-area-weekday" class="message-area"></div>
        <div class="filters">
            <label for="startDate">시작 날짜:</label>
            <input type="date" id="startDate">
            <label for="endDate">종료 날짜:</label>
            <input type="date" id="endDate">
            <button onclick="loadWeekdayStats()">조회</button>
            <span style="margin-left: auto;">
                <label for="chartType">차트 종류:</label>
                <input type="radio" id="chartTypeBar" name="chartType" value="bar" checked onchange="updateWeekdayChart()">
                <label for="chartTypeBar">막대</label>
                <input type="radio" id="chartTypeLine" name="chartType" value="line" onchange="updateWeekdayChart()">
                <label for="chartTypeLine">선</label>
            </span>
            <span>
                <label for="chartDataSelect">차트 데이터:</label>
                <select id="chartDataSelect" onchange="updateWeekdayChart(); displayAverageSummary(currentWeekdayData);"> <!-- 평균 요약도 같이 업데이트 -->
                    <option value="net_profit">순수익</option>
                    <option value="total_profit">총수익</option>
                    <option value="hunting_profit">사냥 수익 (메소+일반템)</option>
                    <option value="jjul_profit">쩔 수익 (쩔비+일반템)</option>
                    <option value="rare_item_profit">고가템 수익</option>
                    <option value="normal_item_profit">일반템 수익</option>
                    <option value="consumable_gained_profit">소모템 획득 수익</option>
                </select>
            </span>
        </div>
        <div class="chart-container">
            <canvas id="weekdayChart"></canvas>
        </div>
         <div id="avgSummary" class="avg-summary" style="display: none;">
            <p><strong>평균 요약:</strong> <span id="avgText"></span></p>
        </div>
        <h3>상세 데이터</h3>
        <div class="table-container">
            <table id="weekdayStatsTable">
                <thead>
                    <tr>
                        <th>요일</th> <th>사냥수익</th> <th>쩔수익</th> <th>고가템수익</th>
                        <th>일반템수익</th> <th>소모템획득수익</th> <th>총수익</th> <th>순수익</th>
                    </tr>
                </thead>
                <tbody>
                    <tr> <td colspan="8" style="text-align:center;">데이터를 조회해주세요.</td> </tr>
                </tbody>
            </table>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 의문의돌맹이. All rights reserved.</p>
    </footer>

    <script>
        // JavaScript 코드는 이전 답변과 동일하게 유지 (API URL 변경 없음)
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const chartDataSelect = document.getElementById('chartDataSelect');
        const weekdayTableBody = document.getElementById('weekdayStatsTable').getElementsByTagName('tbody')[0];
        const messageArea = document.getElementById('message-area-weekday');
        const avgSummaryDiv = document.getElementById('avgSummary');
        const avgTextSpan = document.getElementById('avgText');
        let weekdayChart = null;
        let currentWeekdayData = [];
        const weekdaysOrder = ["월요일", "화요일", "수요일", "목요일", "금요일", "토요일", "일요일"];

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const firstDayLastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            endDateInput.value = today.toISOString().split('T')[0];
            startDateInput.value = firstDayLastMonth.toISOString().split('T')[0];
            loadWeekdayStats();
        });

        async function loadWeekdayStats() {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            if (!startDate || !endDate) { showMessage('시작 날짜와 종료 날짜를 모두 선택해주세요.', 'error'); return; }
            if (startDate > endDate) { showMessage('시작 날짜는 종료 날짜보다 이전이어야 합니다.', 'error'); return; }
            showMessage('');
            weekdayTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">데이터를 불러오는 중...</td></tr>';
            avgSummaryDiv.style.display = 'none';
            const apiUrl = `/api/statistics/weekday?start_date=${startDate}&end_date=${endDate}`; // API URL 유지
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: '데이터 로드 실패' }));
                    throw new Error(errorData.detail || `서버 응답 오류: ${response.status}`);
                }
                currentWeekdayData = await response.json();
                renderWeekdayTable(currentWeekdayData);
                updateWeekdayChart();
                displayAverageSummary(currentWeekdayData);
            } catch (error) {
                showMessage(`오류: ${error.message}`, 'error');
                weekdayTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center; color: red;">데이터 로드 실패</td></tr>`;
                console.error('Error loading weekday statistics:', error);
            }
        }

        function renderWeekdayTable(data) {
            weekdayTableBody.innerHTML = '';
            if (!data || data.length === 0) {
                weekdayTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">해당 기간의 데이터가 없습니다.</td></tr>';
                return;
            }
            data.sort((a, b) => weekdaysOrder.indexOf(a.weekday) - weekdaysOrder.indexOf(b.weekday));
            data.forEach(item => {
                const row = weekdayTableBody.insertRow();
                row.insertCell().textContent = item.weekday || 'N/A';
                row.insertCell().textContent = (item.hunting_profit || 0).toLocaleString();
                row.insertCell().textContent = (item.jjul_profit || 0).toLocaleString();
                row.insertCell().textContent = (item.rare_item_profit || 0).toLocaleString();
                row.insertCell().textContent = (item.normal_item_profit || 0).toLocaleString();
                row.insertCell().textContent = (item.consumable_gained_profit || 0).toLocaleString();
                row.insertCell().textContent = (item.total_profit || 0).toLocaleString();
                row.insertCell().textContent = (item.net_profit || 0).toLocaleString();
            });
        }

        function updateWeekdayChart() {
            if (!currentWeekdayData || currentWeekdayData.length === 0) {
                if (weekdayChart) { weekdayChart.destroy(); weekdayChart = null; }
                return;
            }
            const selectedKey = chartDataSelect.value;
            const selectedLabel = chartDataSelect.options[chartDataSelect.selectedIndex].text;
            const chartType = document.querySelector('input[name="chartType"]:checked').value;
            const sortedData = [...currentWeekdayData].sort((a, b) => weekdaysOrder.indexOf(a.weekday) - weekdaysOrder.indexOf(b.weekday));
            const labels = sortedData.map(item => item.weekday);
            const dataPoints = sortedData.map(item => item[selectedKey] || 0);
            const chartConfig = {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{ label: selectedLabel, data: dataPoints, backgroundColor: chartType === 'bar' ? generateBarColors(labels.length) : 'rgba(75, 192, 192, 0.2)', borderColor: chartType === 'bar' ? generateBarColors(labels.length, true) : getRandomColor(), borderWidth: chartType === 'bar' ? 1 : 2, fill: chartType !== 'bar', tension: 0.1 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: value => value.toLocaleString() } } },
                    plugins: { tooltip: { callbacks: { label: context => `${context.dataset.label || ''}: ${context.parsed.y !== null ? context.parsed.y.toLocaleString() : ''}` } } }
                }
            };
            const ctx = document.getElementById('weekdayChart').getContext('2d');
            if (weekdayChart) { weekdayChart.destroy(); }
            weekdayChart = new Chart(ctx, chartConfig);
        }

        function displayAverageSummary(data) {
             if (!data || data.length === 0) { avgSummaryDiv.style.display = 'none'; return; }
             const selectedKey = chartDataSelect.value;
             const selectedLabel = chartDataSelect.options[chartDataSelect.selectedIndex].text;
             const totalValue = data.reduce((sum, item) => sum + (item[selectedKey] || 0), 0);
             // 요일 데이터는 보통 7개지만, 데이터가 없는 요일이 있을 수 있으므로 실제 데이터 개수로 나눔
             const averageValue = data.length > 0 ? totalValue / data.length : 0;
             avgTextSpan.textContent = `선택된 기간 동안의 ${selectedLabel} 평균은 약 ${averageValue.toLocaleString(undefined, {maximumFractionDigits: 0})} 입니다.`;
             avgSummaryDiv.style.display = 'block';
        }

        function showMessage(message, type = 'info') {
            messageArea.textContent = message;
            messageArea.className = 'message-area ' + type;
        }

        function getRandomColor() {
            const r = Math.floor(Math.random() * 200); const g = Math.floor(Math.random() * 200); const b = Math.floor(Math.random() * 200);
            return `rgb(${r}, ${g}, ${b})`;
        }

        function generateBarColors(count, border = false) {
            const colors = [ 'rgba(255, 99, 132, 0.6)', 'rgba(54, 162, 235, 0.6)', 'rgba(255, 206, 86, 0.6)', 'rgba(75, 192, 192, 0.6)', 'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)', 'rgba(99, 255, 132, 0.6)' ];
            const borderColors = [ 'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)', 'rgba(99, 255, 132, 1)' ];
            const result = [];
            for (let i = 0; i < count; i++) { result.push(border ? borderColors[i % borderColors.length] : colors[i % colors.length]); }
            return result;
        }
    </script>
</body>
