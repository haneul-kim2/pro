<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ëƒ¥ ê¸°ë¡</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}">
    <style>
        /* --- ê¸°ë³¸ ë ˆì´ì•„ì›ƒ (style.css ë¡œ ì´ë™ ê¶Œì¥) --- */
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; color: #333; display: flex; flex-direction: column; min-height: 100vh; }
        header { background: #333; color: #fff; padding: 1rem 0; text-align: center; }
        header h1 { margin: 0; font-size: 1.8rem; }
        nav { background: #444; padding: 0.5rem 0; }
        nav ul { padding: 0; list-style: none; text-align: center; margin: 0; }
        nav ul li { display: inline-block; margin: 0 5px; }
        nav ul li a { text-decoration: none; color: #fff; padding: 10px 15px; display: inline-block; border-radius: 4px; transition: background-color 0.3s ease; }
        nav ul li a:hover, nav ul li a.active { background-color: #555; } /* í™œì„± ë§í¬ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        main.container { flex-grow: 1; width: 90%; max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px; }
        footer { background: #333; color: #fff; text-align: center; padding: 1rem 0; margin-top: auto; width: 100%; }
        /* --- ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë --- */

        /* --- ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ìŠ¤íƒ€ì¼ (style.css ë¡œ ì´ë™ ê¶Œì¥) --- */
        nav ul li.dropdown { position: relative; display: inline-block; }
        nav ul li.dropdown .dropbtn { cursor: default; }
        nav ul li.dropdown .dropdown-content { display: none; position: absolute; background-color: #444; min-width: 120px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; left: 0; border-radius: 0 0 4px 4px; overflow: hidden; }
        nav ul li.dropdown .dropdown-content a { color: white; padding: 10px 15px; text-decoration: none; display: block; text-align: left; white-space: nowrap; }
        nav ul li.dropdown .dropdown-content a:hover { background-color: #555; }
        nav ul li.dropdown:hover .dropdown-content { display: block; }
        /* --- ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ìŠ¤íƒ€ì¼ ë --- */

        /* --- í¼ ë° í…Œì´ë¸” ìŠ¤íƒ€ì¼ (style.css ë¡œ ì´ë™ ê¶Œì¥) --- */
        h2, h3 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; margin-bottom: 20px; }
        h2:first-of-type { margin-top: 0; }
        .form-section { margin-bottom: 30px; padding: 20px; background-color: #f9f9f9; border-radius: 5px; border: 1px solid #eee; } /* ì„¹ì…˜ êµ¬ë¶„ */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px 20px; } /* ê·¸ë¦¬ë“œ ê°„ê²© ì¡°ì • */
        .form-group { margin-bottom: 0; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; font-size: 0.9rem;}
        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group input[type="number"],
        .form-group input[type="time"],
        .form-group select,
        .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.95rem; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: #5cb85c; outline: none; box-shadow: 0 0 5px rgba(92, 184, 92, 0.5); }

        /* ì•„ì´í…œ ëª©ë¡ ìŠ¤íƒ€ì¼ */
        .item-list-section { margin-top: 20px; }
        .item-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; padding: 10px; background-color: #fdfdfd; border-radius: 4px; border: 1px solid #eee;}
        .item-row label { margin-bottom: 0; font-size: 0.85rem; color: #666; min-width: 80px; text-align: right; } /* ë¼ë²¨ ë„ˆë¹„ ê³ ì • ë° ì˜¤ë¥¸ìª½ ì •ë ¬ */
        .item-row input[type="text"], .item-row input[type="number"] { flex-grow: 1; padding: 8px; font-size: 0.9rem; }
        .item-row .item-name { flex-basis: 40%; } /* ì•„ì´í…œëª… ë„ˆë¹„ ì¡°ì ˆ */
        .item-row .item-value { flex-basis: 25%; } /* ê°’ ë„ˆë¹„ ì¡°ì ˆ */
        .item-row .item-qty { flex-basis: 15%; } /* ìˆ˜ëŸ‰ ë„ˆë¹„ ì¡°ì ˆ */
        .item-row button.remove-item-btn { background-color: #d9534f; color: white; border: none; padding: 5px 8px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; line-height: 1; }
        .item-row button.remove-item-btn:hover { background-color: #c9302c; }
        button.add-item-btn { background-color: #5bc0de; color: white; padding: 8px 12px; font-size: 0.9rem; border:none; border-radius: 4px; cursor:pointer; margin-top: 10px; transition: background-color 0.3s ease; }
        button.add-item-btn:hover { background-color: #31b0d5; }

        .button-group { margin-top: 30px; text-align: right; padding-top: 20px; border-top: 1px solid #eee; }
        button[type="submit"] { background-color: #5cb85c; }
        button[type="submit"]:hover { background-color: #4cae4c; }
        button.secondary { background-color: #f0ad4e; margin-left: 10px; }
        button.secondary:hover { background-color: #ec971f; }

        .message-area { padding: 15px; margin-bottom: 20px; border-radius: 4px; border: 1px solid transparent; }
        .message-area.success { background-color: #dff0d8; color: #3c763d; border-color: #d6e9c6; }
        .message-area.error { background-color: #f2dede; color: #a94442; border-color: #ebccd1; }
        .message-area.info { background-color: #d9edf7; color: #31708f; border-color: #bce8f1; }
        .message-area:empty { display: none; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #e0e0e0; padding: 10px 12px; text-align: left; vertical-align: middle; font-size: 0.9rem; }
        th { background-color: #f8f8f8; font-weight: bold; color: #333; text-transform: uppercase; font-size: 0.85rem; }
        tbody tr:nth-child(even) { background-color: #fdfdfd; }
        tbody tr:hover { background-color: #f0f0f0; }
        td { color: #555; }
        td:nth-child(n+5):nth-child(-n+10), /* ë©”ì†Œ ê´€ë ¨ í•„ë“œ */
        td:nth-child(n+17) /* ìˆ˜ìµ ê´€ë ¨ í•„ë“œ */
         { text-align: right; }
        td:nth-child(11), td:nth-child(12) /* ê²½í—˜ì¹˜ í•„ë“œ */
         { text-align: right; }

        /* ë°˜ì‘í˜• í…Œì´ë¸” ìŠ¤í¬ë¡¤ */
        .table-container {
            overflow-x: auto; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ìƒì„± */
            margin-top: 20px;
        }
        .table-container table {
            min-width: 1200px; /* í…Œì´ë¸” ìµœì†Œ ë„ˆë¹„ ì„¤ì • (í•„ìš”ì‹œ ì¡°ì •) */
        }
        /* --- í¼ ë° í…Œì´ë¸” ìŠ¤íƒ€ì¼ ë --- */
    </style>
</head>
<body>
    <header>
        <h1>ë©”ì´í”ŒìŠ¤í† ë¦¬ ìˆ˜ìµ ê¸°ë¡ ì›¹</h1>
    </header>

    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” - ìˆœì„œ ë° ì´ë¦„ ë³€ê²½ -->
<nav>
    <ul>
        <!-- 1. í™ˆ -->
        <li><a href="{{ url_for('home') }}">í™ˆ</a></li>

        <!-- 2. ì‚¬ëƒ¥ -->
        <li><a href="{{ url_for('list_and_add_hunting_sessions') }}" class="active">ì‚¬ëƒ¥</a></li> <!-- í˜„ì¬ í˜ì´ì§€ active í‘œì‹œ -->

        <!-- 3. ì©” -->
        <li><a href="{{ url_for('list_and_add_jjul_sessions') }}">ì©”</a></li>

        <!-- 4. ê²½í—˜ì¹˜ í†µê³„ (ì‹ ê·œ ì¶”ê°€) -->
        <li><a href="{{ url_for('statistics_experience') }}">ê²½í—˜ì¹˜ í†µê³„</a></li>

        <!-- 5. í†µê³„ (ë“œë¡­ë‹¤ìš´) -->
        <li class="dropdown">
            <a href="javascript:void(0)" class="dropbtn">í†µê³„</a>
            <div class="dropdown-content">
                <a href="{{url_for('statistics_daily') }}">ì¼ë³„ ìš”ì•½</a>
                <a href="{{ url_for('statistics_map') }}">ë§µë³„ ìš”ì•½</a>
                <a href="{{ url_for('statistics_weekday') }}">ìš”ì¼ë³„ ìš”ì•½</a>
            </div>
        </li>

        <!-- 6. ë©”ì†Œ íŒë§¤ ê¸°ë¡ (ì´ë¦„ ë³€ê²½) -->
        <li><a href="{{ url_for('list_and_add_meso_sales') }}">ë©”ì†Œ íŒë§¤ ê¸°ë¡</a></li>
    </ul>
</nav>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” ë -->

    <main class="container">
        <h2>ì‚¬ëƒ¥ ê¸°ë¡</h2>
        <div id="message-area-hunting" class="message-area"></div> <!-- ë©”ì‹œì§€ ì˜ì—­ ID í™•ì¸ -->
        <form id="huntingForm">
            <!-- ì‚¬ëƒ¥ ê¸°ë³¸ ì •ë³´ -->
            <div class="form-section">
                <h3>ì‚¬ëƒ¥ ì •ë³´</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="session_date">ë‚ ì§œ:</label>
                        <input type="date" id="session_date" name="session_date" required>
                    </div>
                    <div class="form-group">
                        <label for="map_name">ë§µ ì´ë¦„:</label>
                        <input type="text" id="map_name" name="map_name" placeholder="ì˜ˆ: ë¶ˆíƒ€ëŠ” ê²€ì€êµ¬ìŠ¬ì˜ ì œë‹¨ 3" required>
                    </div>
                    <div class="form-group">
                        <label for="start_time">ì‹œì‘ ì‹œê°„:</label>
                        <input type="time" id="start_time" name="start_time" required>
                    </div>
                    <div class="form-group">
                        <label for="end_time">ì¢…ë£Œ ì‹œê°„:</label>
                        <input type="time" id="end_time" name="end_time" required>
                    </div>
                </div>
            </div>

            <!-- ë©”ì†Œ ë° ê²½í—˜ì¹˜ ì •ë³´ -->
            <div class="form-section">
                <h3>ë©”ì†Œ & ê²½í—˜ì¹˜</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="start_meso">ì‹œì‘ ë©”ì†Œ:</label>
                        <input type="number" id="start_meso" name="start_meso" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="end_meso">ì¢…ë£Œ ë©”ì†Œ:</label>
                        <input type="number" id="end_meso" name="end_meso" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="sold_meso">(ì¡í…œ)íŒë§¤ í›„ ë©”ì†Œ:</label>
                        <input type="number" id="sold_meso" name="sold_meso" value="0" required>
                    </div>
                     <div class="form-group">
                        <label for="entry_fee">ì§€ì°¸ë¹„ (ì„ íƒ):</label>
                        <input type="number" id="entry_fee" name="entry_fee" value="0">
                    </div>
                    <div class="form-group">
                        <label for="start_level">ì‹œì‘ ë ˆë²¨:</label>
                        <input type="number" id="start_level" name="start_level" value="0" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="start_exp_percentage">ì‹œì‘ ê²½í—˜ì¹˜ % (ì†Œìˆ˜ì  2ìë¦¬ê¹Œì§€):</label>
                        <input type="number" id="start_exp_percentage" name="start_exp_percentage" value="0.00" step="0.01" min="0" max="100" required>
                    </div>
                    <div class="form-group">
                        <label for="end_level">ì¢…ë£Œ ë ˆë²¨ (ì„ íƒ):</label>
                        <input type="number" id="end_level" name="end_level" value="" min="0" placeholder="ì‹œì‘ ë ˆë²¨ê³¼ ë™ì¼í•˜ë©´ ë¹„ì›Œë„ ë¨">
                    </div>
                    <div class="form-group">
                        <label for="end_exp_percentage">ì¢…ë£Œ ê²½í—˜ì¹˜ % (ì†Œìˆ˜ì  2ìë¦¬ê¹Œì§€, ì„ íƒ):</label>
                        <input type="number" id="end_exp_percentage" name="end_exp_percentage" value="" step="0.01" min="0" max="100" placeholder="ê²½í—˜ì¹˜ ë³€í™” ì—†ìœ¼ë©´ ë¹„ì›Œë„ ë¨">
                    </div>
                </div>
            </div>

            <!-- ê³ ê°€ ì•„ì´í…œ -->
            <div class="form-section item-list-section">
                <h3>íšë“í•œ ê³ ê°€ ì•„ì´í…œ</h3>
                <div id="rareItemsContainer">
                    <!-- ê³ ê°€ ì•„ì´í…œ í–‰ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
                <button type="button" onclick="addRareItemRow()" class="add-item-btn">ê³ ê°€ ì•„ì´í…œ ì¶”ê°€ (+)</button>
            </div>

            <!-- ì†Œëª¨/íšë“ ì•„ì´í…œ -->
            <div class="form-section item-list-section">
                <h3>ì†Œëª¨/íšë“ ì•„ì´í…œ</h3>
                <div id="consumableItemsContainer">
                    <!-- ì†Œëª¨/íšë“ ì•„ì´í…œ í–‰ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
                <button type="button" onclick="addConsumableRow()" class="add-item-btn">ì†Œëª¨/íšë“ ì•„ì´í…œ ì¶”ê°€ (+)</button>
            </div>

            <div class="button-group">
                <button type="submit">ê¸°ë¡ ì¶”ê°€ ë° ê³„ì‚°</button>
                <button type="button" onclick="resetHuntingForm()" class="secondary">ì–‘ì‹ ì´ˆê¸°í™”</button>
            </div>
        </form>

        <!-- ì‚¬ëƒ¥ ê¸°ë¡ ëª©ë¡ í…Œì´ë¸” -->
        <h3>ì‚¬ëƒ¥ ëª©ë¡</h3>
         <div class="table-container">
             <table id="huntingSessionsTable">
                <thead>
                    <tr>
                        <th>ë‚ ì§œ</th>
                        <th>ë§µëª…</th>
                        <th>ì‹œì‘ì‹œê°„</th>
                        <th>ì¢…ë£Œì‹œê°„</th>
                        <th>ì‹œì‘ë©”ì†Œ</th>
                        <th>ì¢…ë£Œë©”ì†Œ</th>
                        <th>íŒë§¤í›„ë©”ì†Œ</th>
                        <th>ì§€ì°¸ë¹„</th>
                        <th>ê²½ì¿ (15ë¶„)</th>
                        <th>ì‹œì‘ê²½í—˜ì¹˜</th>
                        <th>ì¢…ë£Œê²½í—˜ì¹˜</th>
                        <th>ì‚¬ëƒ¥ë©”ì†Œìˆ˜ìµ</th>
                        <th>ì¼ë°˜í…œìˆ˜ìµ</th>
                        <th>ê³ ê°€í…œê°€ì¹˜</th>
                        <th>ì†Œëª¨ì•„ì´í…œë¹„</th>
                        <th>ì†Œëª¨í…œíšë“ìˆ˜ìµ</th>
                        <th>ì´ìˆ˜ìµ</th>
                        <th>ìˆœìˆ˜ìµ</th>
                        <th>ê²½í—˜ì¹˜ìˆ˜ìµ</th>
                        <th>ì›ê²½í—˜ì¹˜</th>
                        <th>ê¸°ë¡ ì‹œê°„</th>
                        <!-- <th>ì‘ì—…</th> -->
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="21" style="text-align:center;">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
         </div>
    </main>

    <footer>
        <p>Â© 2025 ì˜ë¬¸ì˜ëŒë§¹ì´. All rights reserved.</p>
    </footer>

    <script>
        const huntingForm = document.getElementById('huntingForm');
        const messageArea = document.getElementById('message-area-hunting'); // ID ì¼ì¹˜ì‹œí‚´
        const rareItemsContainer = document.getElementById('rareItemsContainer');
        const consumableItemsContainer = document.getElementById('consumableItemsContainer');
        const huntingTableBody = document.getElementById('huntingSessionsTable').getElementsByTagName('tbody')[0];

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('session_date').value = new Date().toISOString().split('T')[0];
            loadHuntingSessions();
        });

        function addRareItemRow() {
            const index = rareItemsContainer.children.length;
            const div = document.createElement('div');
            div.classList.add('item-row');
            div.innerHTML = `
                <label for="rare_item_name_${index}">ì•„ì´í…œëª…:</label>
                <input type="text" id="rare_item_name_${index}" name="rare_items[${index}][item_name]" placeholder="ì•„ì´í…œ ì´ë¦„" class="item-name">
                <label for="rare_item_value_${index}">ì˜ˆìƒ ê°€ì¹˜:</label>
                <input type="number" id="rare_item_value_${index}" name="rare_items[${index}][item_value]" value="0" min="0" class="item-value">
                <button type="button" onclick="this.closest('.item-row').remove()" class="remove-item-btn">X</button>
            `;
            rareItemsContainer.appendChild(div);
        }

        function addConsumableRow() {
            const index = consumableItemsContainer.children.length;
            const div = document.createElement('div');
            div.classList.add('item-row');
            div.innerHTML = `
                <label for="cons_item_name_${index}">ëª…ì¹­:</label>
                <input type="text" id="cons_item_name_${index}" name="consumable_items[${index}][item_name]" placeholder="ì•„ì´í…œ ì´ë¦„" class="item-name">
                <label for="cons_item_price_${index}">ê°œë‹¹ ê°€ê²©/ê°€ì¹˜:</label>
                <input type="number" id="cons_item_price_${index}" name="consumable_items[${index}][price_or_value_per_item]" value="0" min="0" class="item-value">
                <label for="cons_start_qty_${index}">ì‹œì‘:</label>
                <input type="number" id="cons_start_qty_${index}" name="consumable_items[${index}][start_quantity]" value="0" min="0" class="item-qty">
                <label for="cons_end_qty_${index}">ì¢…ë£Œ:</label>
                <input type="number" id="cons_end_qty_${index}" name="consumable_items[${index}][end_quantity]" value="0" min="0" class="item-qty">
                <button type="button" onclick="this.closest('.item-row').remove()" class="remove-item-btn">X</button>
            `;
            consumableItemsContainer.appendChild(div);
        }

        huntingForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            showMessage('', 'info'); // ì´ì „ ë©”ì‹œì§€ ì´ˆê¸°í™”, infoë¡œ ì‹œì‘

            const formData = new FormData(huntingForm);
            const data = {};

            for (let [key, value] of formData.entries()) {
                if (!key.startsWith('rare_items[') && !key.startsWith('consumable_items[')) {
                    // ìˆ«ì í•„ë“œ ëª©ë¡ì— 'start_level' ì¶”ê°€, 'start_exp_percentage'ëŠ” ë³„ë„ ì²˜ë¦¬
                    if (['start_meso', 'end_meso', 'sold_meso', 'entry_fee', 'coupon_15min_count', 'start_level'].includes(key)) {
                        data[key] = parseInt(value) || 0;
                    } else if (key === 'end_level') { // end_levelì€ ë¹„ì–´ìˆì„ ìˆ˜ ìˆìŒ
                        data[key] = value === '' ? null : (parseInt(value) || 0);
                        if (data[key] === 0 && value !== '0') data[key] = null; 
                    } else if (['start_exp_percentage', 'end_exp_percentage'].includes(key)) {
                        data[key] = value === '' ? null : (parseFloat(value) || 0.0);
                         if (key === 'end_exp_percentage' && data[key] === 0.0 && value !== '0.00' && value !== '0') data[key] = null;
                    }
                    // ğŸš¨ ê¸°ì¡´ start_experience, end_experienceëŠ” HTMLì—ì„œ ì œê±°ë˜ì—ˆìœ¼ë¯€ë¡œ ìë™ìœ¼ë¡œ ì²˜ë¦¬ ì•ˆë¨ ğŸš¨
                    else {
                        data[key] = value;
                    }
                }
            }

            data.rare_items = [];
            const rareItemRows = rareItemsContainer.querySelectorAll('.item-row');
            rareItemRows.forEach((row, index) => {
                const nameInput = row.querySelector(`input[name="rare_items[${index}][item_name]"]`);
                const valueInput = row.querySelector(`input[name="rare_items[${index}][item_value]"]`);
                if (nameInput && valueInput) { // defensive coding
                    const name = nameInput.value.trim();
                    const value = parseInt(valueInput.value) || 0;
                    if (name) { // ì´ë¦„ë§Œ ìˆì–´ë„ ì¼ë‹¨ ì¶”ê°€ (ê°€ì¹˜ëŠ” 0ì¼ ìˆ˜ ìˆìŒ)
                        data.rare_items.push({ item_name: name, item_value: value });
                    }
                }
            });

            data.consumable_items = [];
            const consumableItemRows = consumableItemsContainer.querySelectorAll('.item-row');
            consumableItemRows.forEach((row, index) => {
                const nameInput = row.querySelector(`input[name="consumable_items[${index}][item_name]"]`);
                const priceInput = row.querySelector(`input[name="consumable_items[${index}][price_or_value_per_item]"]`);
                const startQtyInput = row.querySelector(`input[name="consumable_items[${index}][start_quantity]"]`);
                const endQtyInput = row.querySelector(`input[name="consumable_items[${index}][end_quantity]"]`);

                if (nameInput && priceInput && startQtyInput && endQtyInput) { // defensive coding
                    const name = nameInput.value.trim();
                    const price = parseInt(priceInput.value) || 0;
                    const startQty = parseInt(startQtyInput.value) || 0;
                    const endQty = parseInt(endQtyInput.value) || 0;
                    if (name) { // ì´ë¦„ì´ ìˆì„ ë•Œë§Œ ì¶”ê°€
                        data.consumable_items.push({
                            item_name: name,
                            price_or_value_per_item: price,
                            start_quantity: startQty,
                            end_quantity: endQty
                        });
                    }
                }
            });
            
            // ì‚¬ìš©ì ì…ë ¥ê°’ì„ ì„œë²„ ìŠ¤í‚¤ë§ˆì— ë§ê²Œ ë³€í™˜
            // ì˜ˆ: session_date, start_time, end_timeì„ datetime ë¬¸ìì—´ë¡œ ì¡°í•©
            // ì„œë²„ì˜ HuntingSessionCreate ìŠ¤í‚¤ë§ˆê°€ datetimeì„ ê¸°ëŒ€í•œë‹¤ë©´ ì—¬ê¸°ì„œ ë³€í™˜ í•„ìš”
            // í˜„ì¬ëŠ” ë¬¸ìì—´ ê·¸ëŒ€ë¡œ ë³´ë‚´ê³  ì„œë²„ì—ì„œ ì²˜ë¦¬í•œë‹¤ê³  ê°€ì •.
            // ë§Œì•½ ì„œë²„ê°€ start_time, end_timeì„ datetimeìœ¼ë¡œ ê¸°ëŒ€í•œë‹¤ë©´ ì•„ë˜ì™€ ê°™ì´ ì¡°í•©
            // data.start_time = data.session_date + 'T' + data.start_time + ':00';
            // data.end_time = data.session_date + 'T' + data.end_time + ':00';


            try {
                showMessage('ê¸°ë¡ ì¶”ê°€ ë° ê³„ì‚° ì¤‘...', 'info');
                const response = await fetch('/api/hunting-times/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });

                // === ìˆ˜ì •ëœ ì˜¤ë¥˜ ì²˜ë¦¬ ë¶€ë¶„ ===
                if (!response.ok) {
                    const responseText = await response.text(); // ì„œë²„ ì‘ë‹µì„ í…ìŠ¤íŠ¸ë¡œ ë¨¼ì € ë°›ìŒ
                    console.error('Server raw response:', responseText); // ì›ì‹œ ì‘ë‹µ ë¡œê¹…

                    let errorDetail = `HTTP error! status: ${response.status}`;
                    try {
                        const errorJson = JSON.parse(responseText); // JSON íŒŒì‹± ì‹œë„
                        if (errorJson.detail) {
                            if (Array.isArray(errorJson.detail)) {
                                errorDetail = errorJson.detail.map(err => {
                                    let field = err.loc && err.loc.length > 1 ? err.loc[1] : 'ì…ë ¥ê°’';
                                    return `${field}: ${err.msg}`;
                                }).join('; ');
                            } else if (typeof errorJson.detail === 'string') {
                                errorDetail = errorJson.detail;
                            } else {
                                errorDetail = JSON.stringify(errorJson.detail);
                            }
                        } else {
                             errorDetail = responseText; // JSON íŒŒì‹± ì„±ê³µí–ˆìœ¼ë‚˜ detail í•„ë“œê°€ ì—†ëŠ” ê²½ìš°
                        }
                    } catch (e) {
                        // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ, responseText (ì›ë¬¸) ì‚¬ìš©
                        errorDetail = responseText || `An unknown error occurred. Status: ${response.status}`;
                    }
                    throw new Error(errorDetail);
                }
                // === ìˆ˜ì •ëœ ì˜¤ë¥˜ ì²˜ë¦¬ ë¶€ë¶„ ë ===

                const result = await response.json();
                showMessage('ì‚¬ëƒ¥ ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                // resetHuntingForm(); // í¼ ì´ˆê¸°í™” ì£¼ì„ ì²˜ë¦¬ (ì‚¬ìš©ì í”¼ë“œë°± ë°˜ì˜ ê°€ëŠ¥ì„±)
                loadHuntingSessions(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨

            } catch (error) {
                showMessage(`ì˜¤ë¥˜: ${error.message}`, 'error');
                console.error('Error adding hunting session (processed):', error.message);
                console.error('Full error object:', error);
            }
        });

        async function loadHuntingSessions() {
            huntingTableBody.innerHTML = '<tr><td colspan="21" style="text-align:center;">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';
            try {
                const response = await fetch('/api/hunting-times/');
                if (!response.ok) { throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`); }
                const sessions = await response.json();

                huntingTableBody.innerHTML = '';

                if (sessions && sessions.length > 0) {
                     sessions.sort((a, b) => { // ë‚ ì§œ, ê·¸ ë‹¤ìŒ ìƒì„± ì‹œê°„ìœ¼ë¡œ ì •ë ¬
                        const dateComparison = new Date(b.session_date) - new Date(a.session_date);
                        if (dateComparison !== 0) return dateComparison;
                        return new Date(b.created_at) - new Date(a.created_at);
                     });

                    sessions.forEach(session => {
                        const row = huntingTableBody.insertRow();

                        row.insertCell().textContent = session.session_date || 'N/A';
                        row.insertCell().textContent = session.map_name || 'N/A';
                        row.insertCell().textContent = session.start_time || 'N/A';
                        row.insertCell().textContent = session.end_time || 'N/A';
                        row.insertCell().textContent = (session.start_meso || 0).toLocaleString();
                        row.insertCell().textContent = (session.end_meso || 0).toLocaleString();
                        row.insertCell().textContent = (session.sold_meso != null ? session.sold_meso : (session.end_meso || 0)).toLocaleString();
                        row.insertCell().textContent = (session.entry_fee || 0).toLocaleString();
                        row.insertCell().textContent = session.coupon_15min_count || 0;

                        // === âœ¨ ê²½í—˜ì¹˜ ê´€ë ¨ ì»¬ëŸ¼ í‘œì‹œ (ìˆ˜ì •ëœ ë¶€ë¶„) âœ¨ ===
                        // 10. ì‹œì‘ë ˆë²¨(%)
                        let startLevelDisplay = 'N/A';
                        if (session.start_level !== null && session.start_level !== undefined) {
                            startLevelDisplay = `${session.start_level} (${session.start_exp_percentage !== null ? session.start_exp_percentage.toFixed(2) : 'N/A'}%)`;
                        }
                        row.insertCell().textContent = startLevelDisplay;

                        // 11. ì¢…ë£Œë ˆë²¨(%)
                        let endLevelDisplay = 'N/A';
                        if (session.end_level !== null && session.end_level !== undefined) {
                            endLevelDisplay = `${session.end_level} (${session.end_exp_percentage !== null ? session.end_exp_percentage.toFixed(2) : 'N/A'}%)`;
                        }
                        row.insertCell().textContent = endLevelDisplay;
                        // === âœ¨ ê²½í—˜ì¹˜ ê´€ë ¨ ì»¬ëŸ¼ í‘œì‹œ ë âœ¨ ===

                        row.insertCell().textContent = (session.hunting_meso_profit || 0).toLocaleString();
                        row.insertCell().textContent = (session.normal_item_profit || 0).toLocaleString();
                        row.insertCell().textContent = (session.total_rare_item_value || 0).toLocaleString();
                        row.insertCell().textContent = (session.total_consumable_cost || 0).toLocaleString();
                        row.insertCell().textContent = (session.total_consumable_gained_profit || 0).toLocaleString();
                        row.insertCell().textContent = (session.total_profit || 0).toLocaleString();
                        row.insertCell().textContent = (session.net_profit || 0).toLocaleString();

                        // === âœ¨ íšë“ ê²½í—˜ì¹˜ (gained_exp) í‘œì‹œ âœ¨ ===
                        // 19. íšë“ê²½í—˜ì¹˜ (ë˜ëŠ” "ê²½í—˜ì¹˜ìˆ˜ìµ" ì»¬ëŸ¼ì— í•´ë‹¹)
                        row.insertCell().textContent = (session.gained_exp !== null && session.gained_exp !== undefined ? session.gained_exp.toLocaleString() : 'N/A');
                        // === âœ¨ íšë“ ê²½í—˜ì¹˜ í‘œì‹œ ë âœ¨ ===

                        // === âœ¨ "ì›ê²½í—˜ì¹˜" ì»¬ëŸ¼ ì²˜ë¦¬ (ì´ì œ gained_expë¡œ í†µí•©ë˜ì—ˆìœ¼ë¯€ë¡œ ì˜ë¯¸ê°€ ì—†ì„ ìˆ˜ ìˆìŒ) âœ¨ ===
                        // 20. ì›ê²½í—˜ì¹˜
                        row.insertCell().textContent = 'N/A'; // ë˜ëŠ” ì´ ì»¬ëŸ¼ì„ HTML theadì—ì„œ ì œê±°í•˜ëŠ” ê²ƒì„ ê³ ë ¤
                        // === âœ¨ "ì›ê²½í—˜ì¹˜" ì»¬ëŸ¼ ì²˜ë¦¬ ë âœ¨ ===

                        row.insertCell().textContent = session.created_at ? new Date(session.created_at).toLocaleString('ko-KR') : 'N/A';
                    });
                } else {
                    huntingTableBody.innerHTML = '<tr><td colspan="21" style="text-align:center;">ê¸°ë¡ëœ ì‚¬ëƒ¥ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                }
            } catch (error) {
                 huntingTableBody.innerHTML = `<tr><td colspan="21" style="text-align:center; color: red;">ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${error.message}</td></tr>`;
                showMessage(`ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
                console.error('Error loading hunting sessions:', error);
            }
        }

        function showMessage(message, type = 'info') {
            messageArea.textContent = message;
            messageArea.className = 'message-area ' + type; // í´ë˜ìŠ¤ ì¶”ê°€ì‹œ ê³µë°± ì¤‘ìš”
        }

        function resetHuntingForm() {
            huntingForm.reset();
            document.getElementById('session_date').value = new Date().toISOString().split('T')[0];
            rareItemsContainer.innerHTML = '';
            consumableItemsContainer.innerHTML = '';
            showMessage('');
        }
    </script>
</body>
</html>