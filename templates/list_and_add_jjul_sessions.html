<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>쩔 기록</title> <!-- '타임' 제거 -->
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}">
    <style>
        /* 스타일은 이전 답변과 동일하게 유지 (필요시 style.css로 이동) */
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; color: #333; display: flex; flex-direction: column; min-height: 100vh; }
        header { background: #333; color: #fff; padding: 1rem 0; text-align: center; }
        header h1 { margin: 0; font-size: 1.8rem; }
        nav { background: #444; padding: 0.5rem 0; }
        nav ul { padding: 0; list-style: none; text-align: center; margin: 0; }
        nav ul li { display: inline-block; margin: 0 5px; }
        nav ul li a { text-decoration: none; color: #fff; padding: 10px 15px; display: inline-block; border-radius: 4px; transition: background-color 0.3s ease; }
        nav ul li a:hover, nav ul li a.active { background-color: #555; }
        main.container { flex-grow: 1; width: 90%; max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px; }
        footer { background: #333; color: #fff; text-align: center; padding: 1rem 0; margin-top: auto; width: 100%; }
        nav ul li.dropdown { position: relative; display: inline-block; }
        nav ul li.dropdown .dropbtn { cursor: default; }
        nav ul li.dropdown .dropdown-content { display: none; position: absolute; background-color: #444; min-width: 120px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; left: 0; border-radius: 0 0 4px 4px; overflow: hidden; }
        nav ul li.dropdown .dropdown-content a { color: white; padding: 10px 15px; text-decoration: none; display: block; text-align: left; white-space: nowrap; }
        nav ul li.dropdown .dropdown-content a:hover { background-color: #555; }
        nav ul li.dropdown:hover .dropdown-content { display: block; }
        h2, h3 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; margin-bottom: 20px; }
        h2:first-of-type { margin-top: 0; }
        .form-section { margin-bottom: 30px; padding: 20px; background-color: #f9f9f9; border-radius: 5px; border: 1px solid #eee; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px 20px; }
        .form-group { margin-bottom: 0; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; font-size: 0.9rem;}
        .form-group input[type="text"], .form-group input[type="date"], .form-group input[type="number"], .form-group input[type="time"], .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.95rem; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: #5cb85c; outline: none; box-shadow: 0 0 5px rgba(92, 184, 92, 0.5); }
        .item-list-section { margin-top: 20px; }
        .item-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; padding: 10px; background-color: #fdfdfd; border-radius: 4px; border: 1px solid #eee;}
        .item-row label { margin-bottom: 0; font-size: 0.85rem; color: #666; min-width: 80px; text-align: right; }
        .item-row input[type="text"], .item-row input[type="number"] { flex-grow: 1; padding: 8px; font-size: 0.9rem; }
        .item-row .item-name { flex-basis: 40%; }
        .item-row .item-value { flex-basis: 25%; }
        .item-row .item-qty { flex-basis: 15%; }
        .item-row button.remove-item-btn { background-color: #d9534f; color: white; border: none; padding: 5px 8px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; line-height: 1; }
        .item-row button.remove-item-btn:hover { background-color: #c9302c; }
        button.add-item-btn { background-color: #5bc0de; color: white; padding: 8px 12px; font-size: 0.9rem; border:none; border-radius: 4px; cursor:pointer; margin-top: 10px; transition: background-color 0.3s ease; }
        button.add-item-btn:hover { background-color: #31b0d5; }
        .button-group { margin-top: 30px; text-align: right; padding-top: 20px; border-top: 1px solid #eee; }
        button[type="submit"] { background-color: #5cb85c; }
        button[type="submit"]:hover { background-color: #4cae4c; }
        button.secondary { background-color: #f0ad4e; margin-left: 10px; }
        button.secondary:hover { background-color: #ec971f; }
        .message-area { padding: 15px; margin-bottom: 20px; border-radius: 4px; border: 1px solid transparent; }
        .message-area.success { background-color: #dff0d8; color: #3c763d; border-color: #d6e9c6; }
        .message-area.error { background-color: #f2dede; color: #a94442; border-color: #ebccd1; }
        .message-area:empty { display: none; }
        .table-container { overflow-x: auto; margin-top: 20px; }
        .table-container table { min-width: 1000px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #e0e0e0; padding: 10px 12px; text-align: left; vertical-align: middle; font-size: 0.9rem; }
        th { background-color: #f8f8f8; font-weight: bold; color: #333; text-transform: uppercase; font-size: 0.85rem; }
        tbody tr:nth-child(even) { background-color: #fdfdfd; }
        tbody tr:hover { background-color: #f0f0f0; }
        td { color: #555; }
        td:nth-child(n+5):nth-child(-n+10), td:nth-child(n+11) { text-align: right; }
    </style>
</head>
<body>
    <header>
        <h1>메이플스토리 수익 기록 웹</h1>
    </header>

    <!-- 네비게이션 바 - '타임' 텍스트 제거 -->
    <nav>
        <ul>
            <li><a href="{{ url_for('read_home') }}">홈</a></li>
            <li><a href="{{ url_for('meso_sales_page') }}">메소 판매</a></li>
            <li><a href="{{ url_for('hunting_times_page') }}">사냥</a></li> <!-- ' 타임' 제거 -->
            <li><a href="{{ url_for('jjul_times_page') }}" class="active">쩔</a></li>   <!-- ' 타임' 제거, active -->
            <li class="dropdown">
                <a href="javascript:void(0)" class="dropbtn">통계</a>
                <div class="dropdown-content">
                    <a href="{{ url_for('statistics_daily_page') }}">일별 요약</a>
                    <a href="{{ url_for('statistics_map_page') }}">맵별 요약</a>
                    <a href="{{ url_for('statistics_weekday_page') }}">요일별 요약</a>
                </div>
            </li>
        </ul>
    </nav>
    <!-- 네비게이션 바 끝 -->

    <main class="container">
        <h2>쩔 기록</h2> <!-- '타임' 제거 -->
        <div id="message-area-jjul" class="message-area"></div>
        <form id="jjulForm">
             <div class="form-section">
                <h3>기본 정보</h3> <!-- '타임 정보' -> '기본 정보' -->
                <div class="form-grid">
                    <div class="form-group">
                        <label for="session_date">날짜:</label>
                        <input type="date" id="session_date" name="session_date" required>
                    </div>
                    <div class="form-group">
                        <label for="map_name">맵 이름:</label>
                        <input type="text" id="map_name" name="map_name" placeholder="예: 숨겨진 연구열차" required>
                    </div>
                    <div class="form-group">
                        <label for="start_time">시작 시간:</label>
                        <input type="time" id="start_time" name="start_time" required>
                    </div>
                    <div class="form-group">
                        <label for="end_time">종료 시간:</label>
                        <input type="time" id="end_time" name="end_time" required>
                    </div>
                </div>
            </div>
            <div class="form-section">
                <h3>쩔 정보</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="start_meso">시작 메소:</label>
                        <input type="number" id="start_meso" name="start_meso" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="end_meso">종료 메소:</label>
                        <input type="number" id="end_meso" name="end_meso" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="sold_meso">(잡템)판매 후 메소:</label>
                        <input type="number" id="sold_meso" name="sold_meso" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="party_size">쩔 인원 수:</label>
                        <input type="number" id="party_size" name="party_size" value="0" required min="0">
                    </div>
                    <div class="form-group">
                        <label for="price_per_person">1인당 쩔비:</label>
                        <input type="number" id="price_per_person" name="price_per_person" value="0" required min="0">
                    </div>
                </div>
            </div>
             <div class="form-section item-list-section">
                <h3>획득한 고가 아이템</h3>
                <div id="rareItemsContainer"></div>
                <button type="button" onclick="addRareItemRow()" class="add-item-btn">고가 아이템 추가 (+)</button>
            </div>
             <div class="form-section item-list-section">
                <h3>소모/획득 아이템</h3>
                <div id="consumableItemsContainer"></div>
                <button type="button" onclick="addConsumableRow()" class="add-item-btn">소모/획득 아이템 추가 (+)</button>
            </div>
            <div class="button-group">
                <button type="submit">기록 추가 및 계산</button>
                <button type="button" onclick="resetJjulForm()" class="secondary">양식 초기화</button>
            </div>
        </form>

        <h3>쩔 기록 목록</h3> <!-- '타임' 제거 -->
         <div class="table-container">
             <table id="jjulSessionsTable">
                <thead>
                    <tr>
                        <th>날짜</th> <th>맵명</th> <th>시작시간</th> <th>종료시간</th>
                        <th>시작메소</th> <th>종료메소</th> <th>판매후메소</th> <th>쩔인원수</th>
                        <th>1인당쩔비</th> <th>총쩔비</th> <th>일반템수익</th> <th>고가템가치</th>
                        <th>소모아이템비</th> <th>소모템획득수익</th> <th>총수익</th> <th>순수익</th>
                        <th>기록 시간</th>
                    </tr>
                </thead>
                <tbody>
                    <tr> <td colspan="17" style="text-align:center;">목록을 불러오는 중...</td> </tr>
                </tbody>
            </table>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 의문의돌맹이. All rights reserved.</p>
    </footer>

    <script>
        // JavaScript 코드는 이전 답변과 동일하게 유지 (API URL은 '/api/jjul-times/' 사용)
        const jjulForm = document.getElementById('jjulForm');
        const messageArea = document.getElementById('message-area-jjul');
        const rareItemsContainer = document.getElementById('rareItemsContainer');
        const consumableItemsContainer = document.getElementById('consumableItemsContainer');
        const jjulTableBody = document.getElementById('jjulSessionsTable').getElementsByTagName('tbody')[0];

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('session_date').value = new Date().toISOString().split('T')[0];
            loadJjulSessions();
        });

        function addRareItemRow() {
            const index = rareItemsContainer.children.length;
            const div = document.createElement('div');
            div.classList.add('item-row');
            div.innerHTML = `
                <label for="rare_item_name_${index}">아이템명:</label>
                <input type="text" id="rare_item_name_${index}" name="rare_items[${index}][item_name]" placeholder="아이템 이름" class="item-name">
                <label for="rare_item_value_${index}">예상 가치:</label>
                <input type="number" id="rare_item_value_${index}" name="rare_items[${index}][item_value]" value="0" min="0" class="item-value">
                <button type="button" onclick="this.closest('.item-row').remove()" class="remove-item-btn">X</button>
            `;
            rareItemsContainer.appendChild(div);
        }

        function addConsumableRow() {
            const index = consumableItemsContainer.children.length;
            const div = document.createElement('div');
            div.classList.add('item-row');
            div.innerHTML = `
                <label for="cons_item_name_${index}">명칭:</label>
                <input type="text" id="cons_item_name_${index}" name="consumable_items[${index}][item_name]" placeholder="아이템 이름" class="item-name">
                <label for="cons_item_price_${index}">개당 가격/가치:</label>
                <input type="number" id="cons_item_price_${index}" name="consumable_items[${index}][price_or_value_per_item]" value="0" min="0" class="item-value">
                <label for="cons_start_qty_${index}">시작:</label>
                <input type="number" id="cons_start_qty_${index}" name="consumable_items[${index}][start_quantity]" value="0" min="0" class="item-qty">
                <label for="cons_end_qty_${index}">종료:</label>
                <input type="number" id="cons_end_qty_${index}" name="consumable_items[${index}][end_quantity]" value="0" min="0" class="item-qty">
                <button type="button" onclick="this.closest('.item-row').remove()" class="remove-item-btn">X</button>
            `;
            consumableItemsContainer.appendChild(div);
        }

        jjulForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            showMessage('');
            const formData = new FormData(jjulForm);
            const data = {};
            for (let [key, value] of formData.entries()) {
                if (!key.startsWith('rare_items[') && !key.startsWith('consumable_items[')) {
                    if (['start_meso', 'end_meso', 'sold_meso', 'party_size', 'price_per_person'].includes(key)) {
                        data[key] = parseInt(value) || 0;
                    } else { data[key] = value; }
                }
            }
            data.rare_items = [];
            rareItemsContainer.querySelectorAll('.item-row').forEach((row, index) => {
                const name = row.querySelector(`input[name="rare_items[${index}][item_name]"]`).value.trim();
                const value = parseInt(row.querySelector(`input[name="rare_items[${index}][item_value]"]`).value) || 0;
                if (name && value > 0) { data.rare_items.push({ item_name: name, item_value: value }); }
            });
            data.consumable_items = [];
            consumableItemsContainer.querySelectorAll('.item-row').forEach((row, index) => {
                const name = row.querySelector(`input[name="consumable_items[${index}][item_name]"]`).value.trim();
                const price = parseInt(row.querySelector(`input[name="consumable_items[${index}][price_or_value_per_item]"]`).value) || 0;
                const startQty = parseInt(row.querySelector(`input[name="consumable_items[${index}][start_quantity]"]`).value) || 0;
                const endQty = parseInt(row.querySelector(`input[name="consumable_items[${index}][end_quantity]"]`).value) || 0;
                if (name) { data.consumable_items.push({ item_name: name, price_or_value_per_item: price, start_quantity: startQty, end_quantity: endQty }); }
            });

            try {
                showMessage('기록 추가 및 계산 중...', 'info');
                const response = await fetch('/api/jjul-times/', { // API URL: /api/jjul-times/
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: '알 수 없는 서버 오류' }));
                    throw new Error(errorData.detail || '쩔 기록 추가에 실패했습니다.');
                }
                const result = await response.json();
                showMessage('쩔 기록이 성공적으로 추가되었습니다.', 'success');
                resetJjulForm();
                loadJjulSessions();
            } catch (error) {
                showMessage(`오류: ${error.message}`, 'error');
                console.error('Error adding jjul session:', error);
            }
        });

        async function loadJjulSessions() {
            jjulTableBody.innerHTML = '<tr><td colspan="17" style="text-align:center;">목록을 불러오는 중...</td></tr>';
            try {
                const response = await fetch('/api/jjul-times/'); // API URL: /api/jjul-times/
                if (!response.ok) { throw new Error(`서버 응답 오류: ${response.status}`); }
                const sessions = await response.json();
                jjulTableBody.innerHTML = '';
                if (sessions && sessions.length > 0) {
                    sessions.sort((a, b) => new Date(b.session_date) - new Date(a.session_date) || new Date(b.created_at) - new Date(a.created_at));
                    sessions.forEach(session => {
                        const row = jjulTableBody.insertRow();
                        row.insertCell().textContent = session.session_date || 'N/A';
                        row.insertCell().textContent = session.map_name || 'N/A';
                        row.insertCell().textContent = session.start_time || 'N/A';
                        row.insertCell().textContent = session.end_time || 'N/A';
                        row.insertCell().textContent = (session.start_meso || 0).toLocaleString();
                        row.insertCell().textContent = (session.end_meso || 0).toLocaleString();
                        row.insertCell().textContent = (session.sold_meso || session.end_meso || 0).toLocaleString();
                        row.insertCell().textContent = session.party_size || 0;
                        row.insertCell().textContent = (session.price_per_person || 0).toLocaleString();
                        row.insertCell().textContent = (session.total_jjul_fee || 0).toLocaleString();
                        row.insertCell().textContent = (session.normal_item_profit || 0).toLocaleString();
                        row.insertCell().textContent = (session.total_rare_item_value || 0).toLocaleString();
                        row.insertCell().textContent = (session.total_consumable_cost || 0).toLocaleString();
                        row.insertCell().textContent = (session.total_consumable_gained_profit || 0).toLocaleString();
                        row.insertCell().textContent = (session.total_profit || 0).toLocaleString();
                        row.insertCell().textContent = (session.net_profit || 0).toLocaleString();
                        row.insertCell().textContent = session.created_at ? new Date(session.created_at).toLocaleString() : 'N/A';
                    });
                } else {
                    jjulTableBody.innerHTML = '<tr><td colspan="17" style="text-align:center;">기록된 쩔 내역이 없습니다.</td></tr>';
                }
            } catch (error) {
                jjulTableBody.innerHTML = `<tr><td colspan="17" style="text-align:center; color: red;">목록 로드 실패: ${error.message}</td></tr>`;
                showMessage(`목록 로드 실패: ${error.message}`, 'error');
                console.error('Error loading jjul sessions:', error);
            }
        }

        function showMessage(message, type = 'info') {
            messageArea.textContent = message;
            messageArea.className = 'message-area ' + type;
        }

        function resetJjulForm() {
            jjulForm.reset();
            document.getElementById('session_date').value = new Date().toISOString().split('T')[0];
            rareItemsContainer.innerHTML = '';
            consumableItemsContainer.innerHTML = '';
            showMessage('');
        }
    </script>
</body>