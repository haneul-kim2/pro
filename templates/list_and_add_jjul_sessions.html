<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>쩔 기록</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        /* 기본 스타일 (제202번 메시지에서 보내주신 내용과 거의 동일) */
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; color: #333; display: flex; flex-direction: column; min-height: 100vh; }
        header { background: #333; color: #fff; padding: 1.8rem 0; text-align: center; }
        header h1 { margin: 0; font-size: 1.8rem; }
        nav { background: #444; padding: 0.5rem 0; }
        nav ul { padding: 0; list-style: none; text-align: center; margin: 0; }
        nav ul li { display: inline-block; margin: 0 5px; }
        nav ul li a { text-decoration: none; color: #fff; padding: 10px 15px; display: inline-block; border-radius: 4px; transition: background-color 0.3s ease; }
        nav ul li a:hover, nav ul li a.active { background-color: #555; }
        main.container { flex-grow: 1; width: 90%; max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px; }
        footer { background: #333; color: #fff; text-align: center; padding: 1rem 0; margin-top: auto; width: 100%; font-size: 0.9em; }
        nav ul li.dropdown { position: relative; display: inline-block; }
        nav ul li.dropdown .dropbtn { cursor: default; }
        nav ul li.dropdown .dropdown-content { display: none; position: absolute; background-color: #444; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 101; left: 0; border-radius: 0 0 4px 4px; overflow: hidden; }
        nav ul li.dropdown .dropdown-content a { color: white; padding: 10px 15px; text-decoration: none; display: block; text-align: left; white-space: nowrap; }
        nav ul li.dropdown .dropdown-content a:hover { background-color: #555; }
        nav ul li.dropdown:hover .dropdown-content { display: block; }
        
        h2, h3 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; margin-bottom: 20px; }
        h2:first-of-type { margin-top: 0; }

        .form-section { margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 5px; border: 1px solid #eee; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px 20px; }
        .form-group { margin-bottom: 0; display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.9rem;}
        .form-group input[type="text"], .form-group input[type="number"], .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.95rem; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: #5cb85c; outline: none; box-shadow: 0 0 5px rgba(92, 184, 92, 0.5); }
        
        .item-list-section { margin-top: 15px; }
        .item-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 8px; padding: 8px; background-color: #fdfdfd; border-radius: 4px; border: 1px solid #eee;}
        .item-row label { margin-bottom: 0; font-size: 0.85rem; color: #666; min-width: 70px; text-align: right; flex-shrink: 0; margin-right: 5px;}
        .item-row input[type="text"], .item-row input[type="number"] { flex-grow: 1; padding: 8px; font-size: 0.9rem; min-width: 60px; max-width: 150px;}
        .item-row .item-name { flex-basis: auto; flex-grow: 2; min-width: 120px;}
        .item-row .item-value, .item-row .item-qty { flex-basis: auto; flex-grow: 1; }
        .item-row button.remove-item-btn { background-color: #d9534f; color: white; border: none; padding: 5px 8px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; line-height: 1; flex-shrink: 0; margin-left: auto;}
        .item-row button.remove-item-btn:hover { background-color: #c9302c; }
        
        button.add-item-btn { background-color: #5bc0de; color: white; padding: 8px 12px; font-size: 0.9rem; border:none; border-radius: 4px; cursor:pointer; margin-top: 10px; margin-right:5px; transition: background-color 0.3s ease; }
        button.add-item-btn:hover { background-color: #31b0d5; }
        .set-controls { margin-top: 10px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; padding-top: 5px; border-top: 1px dashed #eee; }
        .set-controls label { font-size: 0.9em; margin-right: 0;}
        .set-controls select { padding: 8px; font-size: 0.9rem; flex-grow: 1; min-width: 120px; max-width: 200px; border-radius: 4px; border: 1px solid #ccc;}
        .set-controls button { font-size: 0.85rem; padding: 6px 10px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; }
        
        .button-group { margin-top: 30px; text-align: right; padding-top: 20px; border-top: 1px solid #eee; }
        button[type="submit"], button.action-button { background-color: #5cb85c; color:white; padding: 10px 15px; border:none; border-radius:4px; cursor:pointer; font-size:1rem; }
        button[type="submit"]:hover, button.action-button:hover { background-color: #4cae4c; }
        button.secondary { background-color: #f0ad4e; color:white; padding: 10px 15px; border:none; border-radius:4px; cursor:pointer; font-size:1rem; margin-left: 10px; }
        button.secondary:hover { background-color: #ec971f; }
        
        .message-area { padding: 15px; margin-bottom: 20px; border-radius: 4px; border: 1px solid transparent; display: none; }
        .message-area.success { background-color: #dff0d8; color: #3c763d; border-color: #d6e9c6; }
        .message-area.error { background-color: #f2dede; color: #a94442; border-color: #ebccd1; }
        .message-area.info { background-color: #d9edf7; color: #31708f; border-color: #bce8f1; }
        
        .table-controls { margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .table-container { overflow-x: auto; margin-top: 10px; }
        .table-container table { min-width: 1600px; } 
        table { width: 100%; border-collapse: collapse; margin-top: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #e0e0e0; padding: 8px 10px; text-align: left; vertical-align: middle; font-size: 0.85rem; white-space: nowrap;} 
        th { background-color: #f8f8f8; font-weight: bold; color: #333; font-size: 0.8rem; } 
        tbody tr:nth-child(even) { background-color: #fdfdfd; }
        tbody tr:hover { background-color: #f0f0f0; }
        td { color: #555; }
        td.number-cell { text-align: right; } 
        td.action-cell { text-align: center; white-space: nowrap; }
        td.action-cell button { font-size: 0.8em; padding: 3px 6px; margin: 0 2px; border-radius: 3px; cursor: pointer;}

        .column-toggle-popup { display: none; position: absolute; background-color: white; border: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 15px; z-index: 1000; max-height: 300px; overflow-y: auto; text-align: left;} 
        .column-toggle-popup label { display: block; margin-bottom: 8px; font-size: 0.9em; user-select: none; }
        .column-toggle-popup input[type="checkbox"] { margin-right: 8px; vertical-align: middle; }
        .column-toggle-popup button { display:block; width:100%; margin-top:10px; padding: 8px; font-size:0.9em; }

        .form-stage { display: none; animation: fadeIn 0.3s; } 
        .form-stage.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .flatpickr-calendar { z-index: 1000 !important; }
    </style>
</head>
<body>
    <header>
        <h1>메랜통계</h1>
    </header>
    <nav>
        <ul>
            <li><a href="{{ url_for('home') }}" class="{{ 'active' if request.url.path == url_for('home') else '' }}">홈</a></li>
            <li><a href="{{ url_for('list_and_add_hunting_sessions') }}" class="{{ 'active' if 'hunting-sessions' in request.url.path else '' }}">사냥</a></li>
            <li><a href="{{ url_for('list_and_add_jjul_sessions') }}" class="{{ 'active' if 'jjul-sessions' in request.url.path else '' }}">쩔</a></li>
            
            <li class="dropdown">
                <a href="javascript:void(0)" class="dropbtn {{ 'active' if request.url.path.startswith((url_for('statistics_experience_daily')|string).rsplit('/', 1)[0]) else '' }}">경험치 통계</a>
                <div class="dropdown-content">
                    <a href="{{ url_for('statistics_experience_daily') }}" class="{{ 'active' if request.url.path == url_for('statistics_experience_daily') else '' }}">일별 경험치</a>
                    <a href="{{ url_for('statistics_experience_weekday') }}" class="{{ 'active' if request.url.path == url_for('statistics_experience_weekday') else '' }}">요일별 경험치</a>
                    <a href="{{ url_for('statistics_experience_map') }}" class="{{ 'active' if request.url.path == url_for('statistics_experience_map') else '' }}">맵별 경험치</a>
                    </div>
            </li>

            <li class="dropdown">
                <a href="javascript:void(0)" class="dropbtn {{ 'active' if request.url.path.startswith((url_for('statistics_daily')|string).rsplit('/', 1)[0]) and not request.url.path.startswith((url_for('statistics_experience_daily')|string).rsplit('/', 1)[0]) else '' }}">메소 통계</a>
                <div class="dropdown-content">
                    <a href="{{ url_for('statistics_daily') }}" class="{{ 'active' if request.url.path == url_for('statistics_daily') else '' }}">일별 메소</a>
                    <a href="{{ url_for('statistics_weekday') }}" class="{{ 'active' if request.url.path == url_for('statistics_weekday') else '' }}">요일별 메소</a>
                    <a href="{{ url_for('statistics_map') }}" class="{{ 'active' if request.url.path == url_for('statistics_map') else '' }}">맵별 메소</a>
                </div>
            </li>
            <li><a href="{{ url_for('list_and_add_meso_sales') }}" class="{{ 'active' if 'meso-sales' in request.url.path else '' }}">쌀먹 장부</a></li>
            <li><a href="{{ url_for('info_page') }}" class="active">정보</a></li>
        </ul>
    </nav>
    <main class="container">
        <h2>쩔 기록</h2>
        <div id="message-area-jjul" class="message-area"></div>
        
        <button type="button" id="loadPreviousJjulDataBtn" class="action-button" style="margin-bottom:15px; background-color: #6c757d;">이전 기록 불러오기</button> [이전 기록에 입력하신 종료 데이터가 시작 데이터로 자동 입력됩니다.]</span></label>
        
        <form id="jjulForm">
            <div id="formStage1Jjul" class="form-stage active">
                <div class="form-section">
                    <h3>쩔 준비 정보</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="session_date_flatpickr_jjul">날짜:</label>
                            <input type="text" id="session_date_flatpickr_jjul" name="session_date" required placeholder="날짜를 선택하세요...">
                        </div>
                        <div class="form-group">
                            <label for="map_name_jjul">맵 이름:</label>
                            <input type="text" id="map_name_jjul" name="map_name" placeholder="예: 죽숲" required>
                        </div>
                        <div class="form-group">
                            <label for="start_time_jjul">시작 시간 (선택):</label>
                            <input type="text" id="start_time_jjul" name="start_time" placeholder="예: 0930 또는 14시">
                        </div>
                        <div class="form-group">
                            <label for="start_meso_jjul">시작 메소:</label>
                            <input type="number" id="start_meso_jjul" name="start_meso" value="0" required>
                        </div>
                         <div class="form-group">
                            <label for="party_size_jjul">쩔 인원 수 (본인 제외):</label>
                            <input type="number" id="party_size_jjul" name="party_size" value="0" required min="0">
                        </div>
                        <div class="form-group">
                            <label for="price_per_person_jjul">1인당 쩔비:</label>
                            <input type="number" id="price_per_person_jjul" name="price_per_person" value="0" required min="0">
                        </div>
                    </div>
                </div>
                <div class="form-section item-list-section">
                    <h3>시작 시 소모 아이템 (선택 입력)</h3>
                    <div id="initialConsumableItemsContainerJjul"></div>
                    <button type="button" onclick="addJjulItemRow('initial_consumable')" class="add-item-btn">시작 소모품 추가 (+)</button>
                    <div class="set-controls">
                        <label for="initialConsumableItemSetSelectJjul" style="min-width:fit-content; margin-right:5px;">세트:</label>
                        <select id="initialConsumableItemSetSelectJjul"></select>
                        <button type="button" onclick="loadJjulItemSet('initial_consumable')" class="secondary">불러오기</button>
                        <button type="button" onclick="saveJjulItemSet('initial_consumable')" class="secondary">현재 목록 세트 저장</button>
                        <button type="button" onclick="deleteJjulItemSet('initial_consumable')" class="remove-item-btn" style="margin-left:auto;">선택 세트 삭제</button>
                    </div>
                </div>
                <div class="button-group" style="text-align:center;">
                    <button type="button" id="startJjulBtn" class="action-button">쩔 시작</button>
                </div>
            </div>

            <div id="formStage2Jjul" class="form-stage">
                <div class="form-section">
                    <h3>쩔 결과 정보</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="end_time_jjul">종료 시간:</label>
                            <input type="text" id="end_time_jjul" name="end_time" required placeholder="예: 1700 또는 오후 5:30">
                        </div>
                        <div class="form-group">
                            <label for="end_meso_jjul">종료 메소 (쩔비 받은 후, 잡템 판매 전):</label>
                            <input type="number" id="end_meso_jjul" name="end_meso" value="0" required>
                        </div>
                        <div class="form-group">
                            <label for="sold_meso_jjul">(잡템)판매 후 메소:</label>
                            <input type="number" id="sold_meso_jjul" name="sold_meso" value="0" required>
                        </div>
                    </div>
                </div>

                <div class="form-section item-list-section">
                    <h3>획득한 고가 아이템</h3>
                    <div id="rareItemsContainerJjul"></div>
                    <button type="button" onclick="addJjulItemRow('rare')" class="add-item-btn">고가 아이템 추가 (+)</button>
                    <div class="set-controls">
                        <label for="rareItemSetSelectJjul" style="min-width:fit-content; margin-right:5px;">세트:</label>
                        <select id="rareItemSetSelectJjul"></select>
                        <button type="button" onclick="loadJjulItemSet('rare')" class="secondary">불러오기</button>
                        <button type="button" onclick="saveJjulItemSet('rare')" class="secondary">현재 목록 세트 저장</button>
                        <button type="button" onclick="deleteJjulItemSet('rare')" class="remove-item-btn" style="margin-left:auto;">선택 세트 삭제</button>
                    </div>
                </div>

                <div class="form-section item-list-section">
                    <h3>쩔 중 소모/획득 아이템 최종 정산</h3>
                     <p style="font-size:0.8em; color: #666;">
                        (1단계에서 입력한 '시작 시 소모 아이템'이 여기에 표시됩니다. 해당 아이템의 최종 '종료 수량'과 '개당 가격/가치'를 입력해주세요. 그 외 쩔 중 변동된 다른 아이템도 추가할 수 있습니다.)
                    </p>
                    <div id="consumableItemsContainerJjul"></div>
                    <button type="button" onclick="addJjulItemRow('consumable_stage2_new')" class="add-item-btn">새 소모/획득 아이템 추가 (+)</button>
                     <div class="set-controls">
                        <label for="consumableItemSetSelectJjul" style="min-width:fit-content; margin-right:5px;">세트:</label>
                        <select id="consumableItemSetSelectJjul"></select>
                        <button type="button" onclick="loadJjulItemSet('consumable_stage2')" class="secondary">불러오기</button>
                        <button type="button" onclick="saveJjulItemSet('consumable_stage2')" class="secondary">현재 목록 세트 저장</button>
                        <button type="button" onclick="deleteJjulItemSet('consumable_stage2')" class="remove-item-btn" style="margin-left:auto;">선택 세트 삭제</button>
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit">기록 추가 및 계산</button>
                    <button type="button" onclick="resetJjulForm(true)" class="secondary">양식 초기화</button> 
                </div>
            </div>
        </form>

        <h3>
            쩔 기록 목록
            <div class="table-controls">
                 <button type="button" id="toggleJjulColumnsBtn" class="action-button" style="font-size:0.8em; padding:5px 10px;">컬럼 표시 설정</button>
                 <button type="button" id="deleteAllJjulSessionsBtn" class="action-button" style="font-size:0.8em; padding:5px 10px; background-color: #d9534f;">모든 기록 삭제</button>
            </div>
        </h3>
        <div id="jjulColumnTogglePopup" class="column-toggle-popup"></div>
        
        <div class="table-container">
            <table id="jjulSessionsTable">
                <thead>
                    </thead>
                <tbody>
                    </tbody>
            </table>
           </div>
    </main>

    <footer>
        <p>© 2025 김하늘 (의문의돌맹이). All rights reserved.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/ko.js"></script>

    <script>
        // 전역 변수 및 DOM 요소 참조
        const jjulForm = document.getElementById('jjulForm');
        const messageAreaJjul = document.getElementById('message-area-jjul'); // Updated to match showMessageJjul
        const rareItemsContainerJjul = document.getElementById('rareItemsContainerJjul'); 
        const consumableItemsContainerJjul = document.getElementById('consumableItemsContainerJjul'); 
        const initialConsumableItemsContainerJjul = document.getElementById('initialConsumableItemsContainerJjul');
        const jjulTableHead = document.getElementById('jjulSessionsTable').getElementsByTagName('thead')[0];
        const jjulTableBody = document.getElementById('jjulSessionsTable').getElementsByTagName('tbody')[0];
        const jjulColumnTogglePopup = document.getElementById('jjulColumnTogglePopup');
        
        let sessionDateFlatpickrInstanceJjul = null;
        const startTimeInputJjul = document.getElementById('start_time_jjul'); 
        const endTimeInputJjul = document.getElementById('end_time_jjul');   

        const formStage1Jjul = document.getElementById('formStage1Jjul');
        const formStage2Jjul = document.getElementById('formStage2Jjul');
        const startJjulBtn = document.getElementById('startJjulBtn');
        const finalSubmitButtonJjul = jjulForm.querySelector('button[type="submit"]');
        const loadPreviousJjulDataBtn = document.getElementById('loadPreviousJjulDataBtn');

        const LS_JJUL_COL_VISIBILITY_KEY = 'jjulTableColumnVisibility_v2'; 
        const LS_ITEM_SETS_JJUL_KEY_PREFIX = 'jjulItemSets_v1_'; 

        const jjulTableColumns = [
            { key: 'session_date', header: '날짜', defaultVisible: true, type: 'string' },
            { key: 'map_name', header: '맵명', defaultVisible: true, type: 'string' },
            { key: 'start_time', header: '시작', defaultVisible: true, type: 'string' },
            { key: 'end_time', header: '종료', defaultVisible: true, type: 'string' },
            { key: 'duration_minutes', header: '시간(분)', defaultVisible: true, type: 'number', class: 'number-cell' },
            { key: 'party_size', header: '인원수', defaultVisible: true, type: 'number', class: 'number-cell' },
            { key: 'price_per_person', header: '1인당쩔비', defaultVisible: true, type: 'number', class: 'number-cell' },
            { key: 'total_jjul_fee', header: '총쩔비', defaultVisible: true, type: 'number', class: 'number-cell' },
            { key: 'start_meso', header: '시작메소', defaultVisible: false, type: 'number', class: 'number-cell' },
            { key: 'end_meso', header: '종료메소', defaultVisible: false, type: 'number', class: 'number-cell' },
            { key: 'sold_meso', header: '판매후메소', defaultVisible: false, type: 'number', class: 'number-cell' },
            { key: 'normal_item_profit', header: '일반템', defaultVisible: true, type: 'number', class: 'number-cell' },
            { key: 'total_rare_item_value', header: '고가템', defaultVisible: true, type: 'number', class: 'number-cell' },
            { key: 'total_consumable_gained_profit', header: '소모품획득', defaultVisible: true, type: 'number', class: 'number-cell' },
            { key: 'total_consumable_cost', header: '소모품비용', defaultVisible: true, type: 'number', class: 'number-cell' },
            { key: 'total_profit', header: '총수익', defaultVisible: true, type: 'number', class: 'number-cell' },
            { key: 'net_profit', header: '순수익', defaultVisible: true, type: 'number', class: 'number-cell' },
            { key: 'created_at_display', header: '기록시간', defaultVisible: false, type: 'string' },
            { key: 'actions', header: '작업', defaultVisible: true, type: 'action', class: 'action-cell', noToggle: true } 
        ];
        let jjulColumnVisibility = {}; 
        let tempInitialConsumablesJjul = []; 
        let currentJjulSessionsData = []; 

        // --- 페이지 로드 시 실행 ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log("JJUL Page: DOMContentLoaded event fired.");

            const dateInputJjul = document.getElementById('session_date_flatpickr_jjul'); 
            if (dateInputJjul) {
                sessionDateFlatpickrInstanceJjul = flatpickr(dateInputJjul, {
                    dateFormat: "Y-m-d", defaultDate: "today", locale: "ko"
                });
            }
            const currentStartTimeInputJjul = document.getElementById('start_time_jjul'); 
            const currentEndTimeInputJjul = document.getElementById('end_time_jjul');   
            if (currentStartTimeInputJjul) {
                currentStartTimeInputJjul.addEventListener('blur', formatTimeInput);
                currentStartTimeInputJjul.addEventListener('keydown', function(event) { if (event.key === 'Enter') { formatTimeInput(event); event.preventDefault(); } });
            }
            if (currentEndTimeInputJjul) {
                currentEndTimeInputJjul.addEventListener('blur', formatTimeInput);
                currentEndTimeInputJjul.addEventListener('keydown', function(event) { if (event.key === 'Enter') { formatTimeInput(event); event.preventDefault(); } });
            }
            
            if (formStage1Jjul && formStage2Jjul && startJjulBtn && finalSubmitButtonJjul && loadPreviousJjulDataBtn) {
                formStage1Jjul.classList.add('active'); 
                formStage1Jjul.style.display = 'block'; 
                formStage2Jjul.style.display = 'none';  
                finalSubmitButtonJjul.style.display = 'none'; 

                startJjulBtn.addEventListener('click', function() {
                    let stage1Valid = true;
                    const stage1FieldsToValidate = [
                        {id: 'session_date_flatpickr_jjul', name: '날짜'}, 
                        {id: 'map_name_jjul', name: '맵 이름'},
                        {id: 'start_meso_jjul', name: '시작 메소'}, 
                        {id: 'party_size_jjul', name: '쩔 인원 수'},
                        {id: 'price_per_person_jjul', name: '1인당 쩔비'}
                    ];
                    for(const field of stage1FieldsToValidate) {
                        const el = document.getElementById(field.id);
                        if (el && el.value.trim() === "" && !( (field.id === 'start_meso_jjul' || field.id === 'party_size_jjul' || field.id === 'price_per_person_jjul') && el.value === "0") ) {
                            showMessageJjul(`${field.name} 필드를 입력해주세요.`, 'error', 3000); stage1Valid = false; el.focus(); return;
                        }
                    }
                    
                    if (!startTimeInputJjul.value.trim() && sessionDateFlatpickrInstanceJjul) { 
                        const now = new Date();
                        startTimeInputJjul.value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                        formatTimeInput({target: startTimeInputJjul}); 
                    }
                    
                    tempInitialConsumablesJjul = []; 
                    if (initialConsumableItemsContainerJjul) {
                        initialConsumableItemsContainerJjul.querySelectorAll('.item-row').forEach(row => {
                            const nameInput = row.querySelector('input[name*="[item_name]"]');
                            const startQtyInput = row.querySelector('input[name*="[start_quantity]"]');
                            if (nameInput && nameInput.value.trim() && startQtyInput) {
                                tempInitialConsumablesJjul.push({
                                    item_name: nameInput.value.trim(),
                                    start_quantity: parseInt(startQtyInput.value) || 0,
                                    price_or_value_per_item: 0, 
                                    end_quantity: 0 
                                });
                            }
                        });
                    }
                    
                    if (consumableItemsContainerJjul) {
                        consumableItemsContainerJjul.innerHTML = ''; 
                        tempInitialConsumablesJjul.forEach(itemData => {
                            addJjulItemRow('consumable_stage2_prefill', itemData); 
                        });
                    }
                    
                    formStage1Jjul.style.display = 'none'; formStage1Jjul.classList.remove('active');
                    formStage2Jjul.style.display = 'block'; formStage2Jjul.classList.add('active');
                    finalSubmitButtonJjul.style.display = 'inline-block';
                    startJjulBtn.style.display = 'none'; 
                    loadPreviousJjulDataBtn.style.display = 'none'; 
                });
            }
            
            if(loadPreviousJjulDataBtn) loadPreviousJjulDataBtn.addEventListener('click', loadPreviousJjulData);
            
            const toggleBtnJjul = document.getElementById('toggleJjulColumnsBtn'); 
            if(toggleBtnJjul) toggleBtnJjul.addEventListener('click', toggleColumnPopupJjul); 

            const deleteAllBtn = document.getElementById('deleteAllJjulSessionsBtn'); // Get the delete all button
            if(deleteAllBtn) deleteAllBtn.addEventListener('click', deleteAllJjulSessions); // Attach event listener

            jjulColumnVisibility = loadColumnVisibility(LS_JJUL_COL_VISIBILITY_KEY, jjulTableColumns);
            renderJjulTableHeaders(); 
            setupColumnTogglePopup(LS_JJUL_COL_VISIBILITY_KEY, jjulTableColumns, jjulColumnVisibility, 'jjulColumnTogglePopup', renderJjulTableHeaders, loadJjulSessions); 
            
            loadJjulSessions(); 

            loadItemSetOptionsJjul('initial_consumable'); 
            loadItemSetOptionsJjul('rare');
            loadItemSetOptionsJjul('consumable_stage2'); 
        });

        // --- 유틸리티 함수 ---
        function loadColumnVisibility(key, columnsConfig) {
            const savedVisibility = localStorage.getItem(key);
            if (savedVisibility) {
                try { return JSON.parse(savedVisibility); } catch(e) { console.error("Error parsing column visibility from LS", e); }
            }
            const defaultVisibility = {};
            columnsConfig.forEach(col => {
                defaultVisibility[col.key] = col.defaultVisible !== undefined ? col.defaultVisible : true;
                if (col.noToggle) defaultVisibility[col.key] = true; 
            });
            return defaultVisibility;
        }

        function saveColumnVisibility(key, visibilityConfig) {
            localStorage.setItem(key, JSON.stringify(visibilityConfig));
        }
        
        // --- 시간 입력 자동 포맷 함수 ---
        function formatTimeInput(event) {
            const inputElement = event.target; let originalValue = inputElement.value.trim();
            if (!originalValue) return;
            if (originalValue.match(/^\d{2}:\d{2}$/)) {
                const parts = originalValue.split(':'); const hour = parseInt(parts[0], 10); const minute = parseInt(parts[1], 10);
                if (hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) return; 
                else { inputElement.value = ""; return; }
            }
            let cleanedValue = originalValue.toLowerCase().replace(/[^0-9a-z시:\s]/g, "").replace(/\s+/g, "");
            let digitsOnly = cleanedValue.replace(/[^0-9]/g, ""); 
            let hourStr = ""; let minuteStr = "00"; let isPM = null; 
            if (cleanedValue.includes("시")) {
                const parts = cleanedValue.split("시"); hourStr = parts[0].replace(/[^0-9]/g, "");
                if (parts.length > 1 && parts[1]) { minuteStr = parts[1].replace(/[^0-9]/g, ""); if(minuteStr.length === 1) minuteStr = `0${minuteStr}`; else if (minuteStr.length > 2) minuteStr = minuteStr.substring(0,2); }
                else { minuteStr = "00"; }
                let h = parseInt(hourStr, 10); if (isNaN(h)) { inputElement.value = ""; return; }
                let AmPmIndicatorInSi = cleanedValue.substring(cleanedValue.indexOf("시") + 1).replace(/[^ap오전후]/g, "");
                if (AmPmIndicatorInSi.includes("p") || AmPmIndicatorInSi.includes("오후")) isPM = true; 
                else if (AmPmIndicatorInSi.includes("a") || AmPmIndicatorInSi.includes("오전")) { isPM = false; if (h === 12) h = 0; }
                if (isPM === null) { if (h >= 1 && h <= 6) isPM = true; else if (h === 12) isPM = true; }
                if (isPM && h >= 1 && h <= 11) hourStr = String(h + 12); else if (isPM === false && h === 12) hourStr = "00"; else hourStr = String(h);
                hourStr = hourStr.padStart(2, '0'); minuteStr = minuteStr.padStart(2, '0');
            } else if (cleanedValue.includes("p") || cleanedValue.includes("a") || cleanedValue.includes("pm") || cleanedValue.includes("am")) {
                if (cleanedValue.includes("p")) isPM = true; else if (cleanedValue.includes("a")) isPM = false;
                let timeDigits = cleanedValue.replace(/[apms오전후]/gi, ""); 
                if (timeDigits.includes(":")) { const parts = timeDigits.split(":"); hourStr = parts[0]; minuteStr = parts[1] ? parts[1].padStart(2,'0') : "00";}
                else { 
                    if (timeDigits.length === 1 || timeDigits.length === 2) { hourStr = timeDigits; minuteStr="00"; } 
                    else if (timeDigits.length === 3) { hourStr = timeDigits.substring(0,1); minuteStr = timeDigits.substring(1,3); } 
                    else if (timeDigits.length >= 4) { hourStr = timeDigits.substring(0,2); minuteStr = timeDigits.substring(2,4); }
                    else { hourStr = ""; }
                }
                let h = parseInt(hourStr, 10); if (isNaN(h)) { inputElement.value = ""; return; }
                if (isPM && h >= 1 && h <= 11) hourStr = String(h + 12);
                else if (isPM === false && h === 12) hourStr = "00"; 
                else hourStr = String(h);
                hourStr = hourStr.padStart(2,'0'); minuteStr = minuteStr.padStart(2,'0');
            } else { 
                if (digitsOnly.length === 1) { hourStr = `0${digitsOnly}`; }
                else if (digitsOnly.length === 2) { hourStr = digitsOnly; }
                else if (digitsOnly.length === 3) { hourStr = `0${digitsOnly.substring(0, 1)}`; minuteStr = digitsOnly.substring(1, 3); }
                else if (digitsOnly.length >= 4) { hourStr = digitsOnly.substring(0, 2); minuteStr = digitsOnly.substring(2, 4); }
                else if (originalValue.trim() !== "") { inputElement.value = ""; return; } else { return; }
            }
            let finalHour = parseInt(hourStr, 10); let finalMinute = parseInt(minuteStr, 10);
            if (!isNaN(finalHour) && !isNaN(finalMinute) && finalHour >= 0 && finalHour <= 23 && finalMinute >= 0 && finalMinute <= 59) {
                inputElement.value = `${String(finalHour).padStart(2, '0')}:${String(finalMinute).padStart(2, '0')}`;
            } else if (originalValue.trim() !== "") { inputElement.value = ""; }
        }
        
        // --- 아이템 행 추가/삭제 함수 ---
        function removeItemRow(buttonElement) { buttonElement.closest('.item-row').remove(); }
        
        function addJjulItemRow(itemType, itemData = {}) {
            const isInitialConsumableStage1 = itemType === 'initial_consumable';      
            const isConsumableStage2Prefill = itemType === 'consumable_stage2_prefill';
            const isConsumableStage2New = itemType === 'consumable_stage2_new';    
            const isRareItem = itemType === 'rare';

            let container, baseIdPrefix, itemNamePrefixForForm, namePlaceholder;
            let nameIsReadOnly = false; let startQtyIsReadOnly = false;

            if (isInitialConsumableStage1) {
                container = initialConsumableItemsContainerJjul;
                baseIdPrefix = 'jjul_init_cons_'; itemNamePrefixForForm = 'initial_consumable_items_jjul'; namePlaceholder = "시작 소모품";
            } else if (isRareItem) {
                container = rareItemsContainerJjul;
                baseIdPrefix = 'jjul_rare_'; itemNamePrefixForForm = 'rare_items'; namePlaceholder = "고가 아이템";
            } else if (isConsumableStage2Prefill || isConsumableStage2New) {
                container = consumableItemsContainerJjul;
                baseIdPrefix = 'jjul_cons_'; itemNamePrefixForForm = 'consumable_items'; namePlaceholder = "소모/획득 아이템";
                if (isConsumableStage2Prefill) { nameIsReadOnly = true; startQtyIsReadOnly = true; }
            } else { console.error(`JJUL PAGE: Unknown itemType "${itemType}"`); return; }

            if (!container) { console.error(`JJUL PAGE: Container for ${itemType} not found!`); showMessageJjul("아이템 추가 영역을 찾지 못했습니다.", "error", 3000); return; }
            
            const formArrayIndex = container.children.length; 
            const elementIdSuffix = Date.now() + "_" + Math.random().toString(36).substring(2, 7);
            const div = document.createElement('div'); div.classList.add('item-row');
            let rowHtml = '';

            if (isRareItem) {
                rowHtml = `
                    <label for="${baseIdPrefix}name_${elementIdSuffix}">아이템명:</label>
                    <input type="text" id="${baseIdPrefix}name_${elementIdSuffix}" name="${itemNamePrefixForForm}[${formArrayIndex}][item_name]" value="${itemData.item_name || ''}" placeholder="${namePlaceholder}" class="item-name">
                    <label for="${baseIdPrefix}value_${elementIdSuffix}">예상 가치:</label>
                    <input type="number" id="${baseIdPrefix}value_${elementIdSuffix}" name="${itemNamePrefixForForm}[${formArrayIndex}][item_value]" value="${itemData.item_value || 0}" min="0" class="item-value">`;
            } else { 
                rowHtml = `
                    <label for="${baseIdPrefix}name_${elementIdSuffix}">명칭:</label>
                    <input type="text" id="${baseIdPrefix}name_${elementIdSuffix}" name="${itemNamePrefixForForm}[${formArrayIndex}][item_name]" value="${itemData.item_name || ''}" placeholder="${namePlaceholder}" class="item-name" ${nameIsReadOnly ? 'readonly' : ''}>
                    <label for="${baseIdPrefix}start_qty_${elementIdSuffix}">시작 수량:</label>
                    <input type="number" id="${baseIdPrefix}start_qty_${elementIdSuffix}" name="${itemNamePrefixForForm}[${formArrayIndex}][start_quantity]" value="${itemData.start_quantity || 0}" min="0" class="item-qty" ${startQtyIsReadOnly ? 'readonly' : ''}>`;
                if (isConsumableStage2Prefill || isConsumableStage2New) {
                    rowHtml += `
                        <label for="${baseIdPrefix}price_${elementIdSuffix}">개당 가격/가치:</label>
                        <input type="number" id="${baseIdPrefix}price_${elementIdSuffix}" name="${itemNamePrefixForForm}[${formArrayIndex}][price_or_value_per_item]" value="${itemData.price_or_value_per_item || 0}" min="0" class="item-value">
                        <label for="${baseIdPrefix}end_qty_${elementIdSuffix}">종료 수량:</label>
                        <input type="number" id="${baseIdPrefix}end_qty_${elementIdSuffix}" name="${itemNamePrefixForForm}[${formArrayIndex}][end_quantity]" value="${itemData.end_quantity || 0}" min="0" class="item-qty">`;
                } else {
                     rowHtml += `<input type="hidden" name="${itemNamePrefixForForm}[${formArrayIndex}][price_or_value_per_item]" value="0">
                                 <input type="hidden" name="${itemNamePrefixForForm}[${formArrayIndex}][end_quantity]" value="${itemData.start_quantity || 0}">`;
                }
            }
            rowHtml += `<button type="button" onclick="removeItemRow(this)" class="remove-item-btn">X</button>`;
            div.innerHTML = rowHtml; container.appendChild(div);
        }
        
        // --- 세트 기능 함수 ---
        function getJjulItemSetStorageKey(itemType) {
            const typeKey = (itemType === 'consumable_stage2_prefill' || itemType === 'consumable_stage2_new') ? 'consumable_stage2' : itemType;
            return `${LS_ITEM_SETS_JJUL_KEY_PREFIX}${typeKey}`; 
        }

        function saveJjulItemSet(itemType) {
            let container;
            if (itemType === 'initial_consumable') container = initialConsumableItemsContainerJjul;
            else if (itemType === 'rare') container = rareItemsContainerJjul;
            else if (itemType === 'consumable_stage2') container = consumableItemsContainerJjul;
            else { console.error("SaveSet: Unknown itemType", itemType); return; }

            if (!container) { showMessageJjul("아이템 목록 컨테이너를 찾을 수 없습니다.", "error", 3000); return; }

            const setName = prompt("저장할 세트의 이름을 입력하세요:");
            if (!setName || !setName.trim()) { 
                showMessageJjul("세트 이름이 유효하지 않아 저장이 취소되었습니다.", "info", 3000); 
                return; 
            }

            const items = [];
            container.querySelectorAll('.item-row').forEach(row => {
                const nameInput = row.querySelector('input[name*="[item_name]"]');
                const name = nameInput ? nameInput.value.trim() : "";
                if (!name) return; 

                const item = { item_name: name };
                if (itemType === 'rare') {
                    const valueInput = row.querySelector('input[name*="[item_value]"]');
                    item.item_value = valueInput ? (parseInt(valueInput.value) || 0) : 0;
                } else { 
                    const startQtyInput = row.querySelector('input[name*="[start_quantity]"]');
                    item.start_quantity = startQtyInput ? (parseInt(startQtyInput.value) || 0) : 0;
                    
                    if (itemType === 'consumable_stage2') { 
                        const priceInput = row.querySelector('input[name*="[price_or_value_per_item]"]');
                        const endQtyInput = row.querySelector('input[name*="[end_quantity]"]');
                        item.price_or_value_per_item = priceInput ? (parseInt(priceInput.value) || 0) : 0;
                        item.end_quantity = endQtyInput ? (parseInt(endQtyInput.value) || 0) : 0;
                    }
                }
                items.push(item);
            });

            if (items.length === 0) { showMessageJjul("세트에 저장할 아이템이 없습니다.", "info", 3000); return; }
            
            const storageKey = getJjulItemSetStorageKey(itemType);
            let sets = JSON.parse(localStorage.getItem(storageKey)) || {};
            sets[setName.trim()] = items;
            localStorage.setItem(storageKey, JSON.stringify(sets));
            showMessageJjul(`'${setName.trim()}' 세트가 저장되었습니다.`, 'success', 3000);
            loadItemSetOptionsJjul(itemType); 
        }

        function loadJjulItemSet(itemType) {
            const selectElementId = itemType === 'initial_consumable' ? 'initialConsumableItemSetSelectJjul' : 
                                    (itemType === 'rare' ? 'rareItemSetSelectJjul' : 'consumableItemSetSelectJjul');
            const selectElement = document.getElementById(selectElementId);
            
            let container;
            if (itemType === 'initial_consumable') container = initialConsumableItemsContainerJjul;
            else if (itemType === 'rare') container = rareItemsContainerJjul;
            else if (itemType === 'consumable_stage2') container = consumableItemsContainerJjul;
            else { console.error("LoadSet: Unknown itemType", itemType); return; }

            if (!selectElement || !container) { showMessageJjul("세트 로드 요소를 찾을 수 없습니다.", "error", 3000); return;}
            const setName = selectElement.value;
            if (!setName) { showMessageJjul("불러올 세트를 선택하세요.", "error", 3000); return; }

            const storageKey = getJjulItemSetStorageKey(itemType);
            const sets = JSON.parse(localStorage.getItem(storageKey)) || {};
            const itemsToLoad = sets[setName];
            if (!itemsToLoad) { showMessageJjul("선택한 세트를 찾을 수 없습니다.", "error", 3000); return; }

            container.innerHTML = ''; 
            itemsToLoad.forEach(itemData => {
                const typeForAddRow = (itemType === 'consumable_stage2') ? 'consumable_stage2_new' : itemType;
                addJjulItemRow(typeForAddRow, itemData); 
            });
            showMessageJjul(`'${setName}' 세트를 불러왔습니다.`, 'success', 3000);
        }

        function loadItemSetOptionsJjul(itemType) {
            const selectElementId = itemType === 'initial_consumable' ? 'initialConsumableItemSetSelectJjul' :
                                    (itemType === 'rare' ? 'rareItemSetSelectJjul' : 'consumableItemSetSelectJjul');
            const selectElement = document.getElementById(selectElementId);
            if (!selectElement) { 
                console.warn(`Set select element not found for ${itemType} (ID: ${selectElementId})`); 
                return; 
            }
            
            const storageKey = getJjulItemSetStorageKey(itemType);
            const sets = JSON.parse(localStorage.getItem(storageKey)) || {};
            
            const currentSelectedValue = selectElement.value;
            selectElement.innerHTML = '<option value="">세트 선택...</option>'; 
            for (const setName in sets) {
                if (sets.hasOwnProperty(setName)) {
                    const option = document.createElement('option'); option.value = setName; option.textContent = setName;
                    selectElement.appendChild(option);
                }
            }
            if (sets.hasOwnProperty(currentSelectedValue)) { 
                selectElement.value = currentSelectedValue;
            }
        }

        function deleteJjulItemSet(itemType) {
            const selectElementId = itemType === 'initial_consumable' ? 'initialConsumableItemSetSelectJjul' :
                                    (itemType === 'rare' ? 'rareItemSetSelectJjul' : 'consumableItemSetSelectJjul');
            const selectElement = document.getElementById(selectElementId);
            if (!selectElement) return;
            const setName = selectElement.value;
            if (!setName) { showMessageJjul("삭제할 세트를 선택하세요.", "error", 3000); return; }

            if (confirm(`'${setName}' 세트를 정말 삭제하시겠습니까?`)) {
                const storageKey = getJjulItemSetStorageKey(itemType);
                let sets = JSON.parse(localStorage.getItem(storageKey)) || {};
                delete sets[setName];
                localStorage.setItem(storageKey, JSON.stringify(sets));
                showMessageJjul(`'${setName}' 세트가 삭제되었습니다.`, 'success', 3000);
                loadItemSetOptionsJjul(itemType); 
            }
        }
        
        // --- 테이블 헤더 렌더링 함수 ---
        function renderJjulTableHeaders() {
            if (!jjulTableHead) return;
            jjulTableHead.innerHTML = ''; 
            const headerRow = jjulTableHead.insertRow();
            jjulTableColumns.forEach(col => {
                if (jjulColumnVisibility[col.key]) {
                    const th = document.createElement('th');
                    th.textContent = col.header;
                    headerRow.appendChild(th);
                }
            });
        }

        // --- 쩔 세션 목록 로드 및 테이블 바디 렌더링 함수 ---
        async function loadJjulSessions() {
            if (!jjulTableBody) return; // messageAreaJjul check removed as showMessageJjul handles it
            showMessageJjul('쩔 기록 목록을 불러오는 중...', 'info');
            const colspanCount = Object.values(jjulColumnVisibility).filter(v => v).length || jjulTableColumns.length;
            jjulTableBody.innerHTML = `<tr><td colspan="${colspanCount}" style="text-align:center;">목록을 불러오는 중...</td></tr>`;

            try {
                const response = await fetch('/api/jjul-times/'); 
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: `서버 응답 오류: ${response.status}` }));
                    throw new Error(errorData.detail || `서버 응답 오류: ${response.status}`);
                }
                const sessions = await response.json();
                currentJjulSessionsData = sessions; 
                renderJjulTableHeaders(); 
                renderJjulTableBody(sessions);    
                showMessageJjul(''); 
            } catch (error) {
                console.error('쩔 기록 목록 로딩 오류:', error);
                showMessageJjul(`목록 로드 실패: ${error.message}`, 'error', 5000);
                jjulTableBody.innerHTML = `<tr><td colspan="${colspanCount}" style="text-align:center; color: red;">목록 로드 실패: ${error.message}</td></tr>`;
            }
        }

        function renderJjulTableBody(sessions) {
            if (!jjulTableBody) return;
            jjulTableBody.innerHTML = ''; 
            const colspanCount = Object.values(jjulColumnVisibility).filter(v => v).length || jjulTableColumns.length;

            if (!sessions || sessions.length === 0) {
                jjulTableBody.innerHTML = `<tr><td colspan="${colspanCount}" style="text-align:center;">기록된 쩔 세션이 없습니다.</td></tr>`;
                return;
            }
            
            sessions.sort((a, b) => {
                const dateComparison = new Date(b.session_date) - new Date(a.session_date);
                if (dateComparison !== 0) return dateComparison;
                return (b.id || 0) - (a.id || 0); 
            });

            sessions.forEach(session => {
                const row = jjulTableBody.insertRow();
                jjulTableColumns.forEach(col => {
                    if (jjulColumnVisibility[col.key]) {
                        const cell = row.insertCell();
                        let cellValue = session[col.key];

                        if (col.key === 'created_at_display' && session.created_at) {
                            cellValue = new Date(session.created_at).toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false });
                        } else if (['party_size', 'duration_minutes'].includes(col.key) && (cellValue === null || cellValue === undefined)) {
                             cellValue = '0'; 
                        } else if (['price_per_person', 'total_jjul_fee', 'start_meso', 'end_meso', 'sold_meso', 'normal_item_profit', 'total_rare_item_value', 'total_consumable_gained_profit', 'total_consumable_cost', 'total_profit', 'net_profit'].includes(col.key)) {
                            cellValue = (cellValue !== null && cellValue !== undefined) ? Number(cellValue).toLocaleString() : '0';
                        }

                        cell.textContent = cellValue !== null && cellValue !== undefined ? cellValue : '';
                        if (col.class) cell.className = col.class;

                        if (col.key === 'actions') {
                            cell.innerHTML = ''; 
                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = '삭제';
                            deleteButton.className = 'remove-item-btn'; 
                            deleteButton.style.backgroundColor = '#d9534f'; deleteButton.style.color = 'white'; 
                            deleteButton.onclick = function() { deleteJjulSession(session.id); }; 
                            cell.appendChild(deleteButton);
                        }
                    }
                });
            });
        }

        // --- 컬럼 선택 팝업 설정 함수 ---
        function setupColumnTogglePopup(key, columnsConfig, visibilityConfig, popupId, renderHeadersFunc, loadDataFunc) {
            const popup = document.getElementById(popupId); 
            if (!popup) return;

            popup.innerHTML = ''; 

            columnsConfig.forEach(col => {
                if (col.noToggle) return; 

                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = col.key;
                checkbox.checked = visibilityConfig[col.key];
                checkbox.onchange = function() {
                    visibilityConfig[col.key] = checkbox.checked;
                    saveColumnVisibility(key, visibilityConfig);
                    renderHeadersFunc(); 
                    renderJjulTableBody(currentJjulSessionsData); 
                };
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(` ${col.header}`));
                popup.appendChild(label);
            });

            const closeButton = document.createElement('button');
            closeButton.textContent = '닫기';
            closeButton.style.marginTop = '10px'; 
            closeButton.onclick = function() { toggleColumnPopupJjul(); };
            popup.appendChild(closeButton);
        }

        // --- 컬럼 선택 팝업 보이기/숨기기 함수 ---
        function toggleColumnPopupJjul() {
            if (!jjulColumnTogglePopup) return;

            if (jjulColumnTogglePopup.style.display === 'block') {
                jjulColumnTogglePopup.style.display = 'none';
            } else {
                jjulColumnTogglePopup.style.display = 'block';
                const button = document.getElementById('toggleJjulColumnsBtn');
                if (button) {
                    const rect = button.getBoundingClientRect();
                    let top = rect.bottom + window.scrollY;
                    let left = rect.left + window.scrollX;

                    jjulColumnTogglePopup.style.top = top + 'px';
                    jjulColumnTogglePopup.style.left = left + 'px';
                    
                    if (left + jjulColumnTogglePopup.offsetWidth > window.innerWidth) {
                        jjulColumnTogglePopup.style.left = (window.innerWidth - jjulColumnTogglePopup.offsetWidth - 10) + 'px'; 
                    }
                    if (top + jjulColumnTogglePopup.offsetHeight > window.innerHeight + window.scrollY) {
                         jjulColumnTogglePopup.style.top = (rect.top + window.scrollY - jjulColumnTogglePopup.offsetHeight) + 'px';
                    }
                }
            }
        }

        // --- 이전 기록 불러오기 함수 ---
        async function loadPreviousJjulData() {
            showMessageJjul('이전 기록을 불러오는 중...', 'info');
            try {
                const response = await fetch('/api/jjul-times/last/');
                if (!response.ok) {
                    if (response.status === 404) {
                        showMessageJjul('불러올 이전 쩔 기록이 없습니다.', 'info', 3000);
                        return;
                    }
                    const errorData = await response.json().catch(() => null);
                    throw new Error(errorData?.detail || `서버 오류: ${response.status}`);
                }

                const lastSession = await response.json();

                if (lastSession) {
                    const mapNameInput = document.getElementById('map_name_jjul');
                    const partySizeInput = document.getElementById('party_size_jjul');
                    const pricePerPersonInput = document.getElementById('price_per_person_jjul');

                    if (mapNameInput) mapNameInput.value = lastSession.map_name || '';
                    if (partySizeInput) partySizeInput.value = lastSession.party_size !== null ? lastSession.party_size : 0;
                    if (pricePerPersonInput) pricePerPersonInput.value = lastSession.price_per_person !== null ? lastSession.price_per_person : 0;
                    
                    showMessageJjul('이전 기록을 참고하여 일부 정보를 불러왔습니다. 날짜, 시간, 시작 메소 및 소모품은 직접 확인 후 입력하거나 세트 기능을 이용해주세요.', 'success', 5000);

                } else {
                    showMessageJjul('불러올 이전 쩔 기록이 없습니다.', 'info', 3000);
                }

            } catch (error) {
                console.error('이전 쩔 기록 로딩 중 오류 발생:', error);
                showMessageJjul(`오류 발생: ${error.message}`, 'error', 5000);
            }
        }
        
        // --- 폼 제출 핸들러 ---
        jjulForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            showMessageJjul('기록 추가 및 계산 중...', 'info');
            const data = {};

            data.session_date = document.getElementById('session_date_flatpickr_jjul').value;
            data.map_name = document.getElementById('map_name_jjul').value;
            data.start_time = document.getElementById('start_time_jjul').value;
            data.start_meso = parseInt(document.getElementById('start_meso_jjul').value) || 0;
            data.party_size = parseInt(document.getElementById('party_size_jjul').value) || 0;
            data.price_per_person = parseInt(document.getElementById('price_per_person_jjul').value) || 0;
            
            data.end_time = document.getElementById('end_time_jjul').value;
            data.end_meso = parseInt(document.getElementById('end_meso_jjul').value) || 0;
            data.sold_meso = parseInt(document.getElementById('sold_meso_jjul').value) || 0;

            let raw_rare_items = []; data.total_rare_item_value = 0;
            if(rareItemsContainerJjul) rareItemsContainerJjul.querySelectorAll('.item-row').forEach(row => {
                const name = row.querySelector('input[name*="[item_name]"]').value.trim();
                const value = parseInt(row.querySelector('input[name*="[item_value]"]').value) || 0;
                if (name) { raw_rare_items.push({ item_name: name, item_value: value }); data.total_rare_item_value += value; }
            });
            data.rare_items_detail = JSON.stringify(raw_rare_items);

            let final_consumable_items = []; data.total_consumable_cost = 0; data.total_consumable_gained_profit = 0;
            if(consumableItemsContainerJjul) { 
                consumableItemsContainerJjul.querySelectorAll('.item-row').forEach(row => {
                    const nameInput = row.querySelector('input[name*="[item_name]"]');
                    const priceInput = row.querySelector('input[name*="[price_or_value_per_item]"]');
                    const startQtyInput = row.querySelector('input[name*="[start_quantity]"]');
                    const endQtyInput = row.querySelector('input[name*="[end_quantity]"]');
                    if (nameInput && nameInput.value.trim() && priceInput && startQtyInput && endQtyInput) {
                        const name = nameInput.value.trim(); const price = parseInt(priceInput.value) || 0;
                        const startQty = parseInt(startQtyInput.value) || 0; const endQty = parseInt(endQtyInput.value) || 0;
                        final_consumable_items.push({ item_name: name, price_or_value_per_item: price, start_quantity: startQty, end_quantity: endQty });
                        const quantity_change = endQty - startQty;
                        if (quantity_change < 0) { data.total_consumable_cost += (-quantity_change * price); }
                        else if (quantity_change > 0) { data.total_consumable_gained_profit += (quantity_change * price); }
                    }
                });
            }
            data.consumable_items_detail = JSON.stringify(final_consumable_items);

            data.total_jjul_fee = (data.party_size || 0) * (data.price_per_person || 0);
            let actual_sold_meso_for_jjul = data.sold_meso;
            if (actual_sold_meso_for_jjul === 0 && data.end_meso > data.start_meso) { 
                actual_sold_meso_for_jjul = data.end_meso; 
            } else if (actual_sold_meso_for_jjul === 0 && data.end_meso !== null && data.end_meso <= data.start_meso ) {
                 actual_sold_meso_for_jjul = data.end_meso;
            } else if (actual_sold_meso_for_jjul === 0 && data.end_meso === 0 && data.start_meso === 0) {
                actual_sold_meso_for_jjul = 0;
            } else if (data.sold_meso === 0 && data.end_meso === 0 && data.start_meso > 0) {
                 actual_sold_meso_for_jjul = 0;
            }
            data.normal_item_profit = actual_sold_meso_for_jjul - (data.end_meso || 0);
            if (data.normal_item_profit < 0) data.normal_item_profit = 0; 
            data.total_profit = (data.total_jjul_fee || 0) + (data.normal_item_profit || 0) + (data.total_rare_item_value || 0) + (data.total_consumable_gained_profit || 0);
            data.net_profit = (data.total_profit || 0) - (data.total_consumable_cost || 0);
            
            try {
                const response = await fetch('/api/jjul-times/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (!response.ok) { 
                    const responseText = await response.text(); let errorDetail = `HTTP error ${response.status}: ${responseText}`;
                    try{ const errorJson = JSON.parse(responseText); if(errorJson.detail) errorDetail = errorJson.detail; } catch(e){}
                    throw new Error(errorDetail); 
                }
                const result = await response.json();
                showMessageJjul('쩔 기록이 성공적으로 추가되었습니다.', 'success', 3000);
                resetJjulForm(true); 
                loadJjulSessions(); 
            } catch (error) { showMessageJjul(`오류: ${error.message}`, 'error', 5000); console.error('Error adding jjul session:', error); }
        });
        
        // --- 삭제 기능 함수 ---
        async function deleteJjulSession(sessionId) { 
            if(confirm(`쩔 기록 ID ${sessionId}번을 정말 삭제하시겠습니까?`)) { 
                showMessageJjul(`ID ${sessionId} 기록 삭제 중...`, 'info');
                try {
                    const response = await fetch(`/api/jjul-times/${sessionId}`, { method: 'DELETE' });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({detail: "삭제 중 알 수 없는 오류 발생"}));
                        throw new Error(errorData.detail || `HTTP error ${response.status}`);
                    }
                    showMessageJjul(`ID ${sessionId} 기록이 삭제되었습니다.`, 'success', 3000);
                    loadJjulSessions();
                } catch (error) {
                    showMessageJjul(`삭제 오류: ${error.message}`, 'error', 5000);
                    console.error('Error deleting jjul session:', error);
                }
            }
        }
        
        /**
         * 모든 쩔 세션 기록을 삭제하는 함수입니다.
         */
        async function deleteAllJjulSessions() {
            const recordType = "쩔"; 
            const confirmationMessage = `정말로 모든 ${recordType} 기록을 삭제하시겠습니까? 이 작업은 되돌릴 수 없으며, 저장된 모든 ${recordType} 데이터가 영구적으로 사라집니다. 계속하시려면 '확인'을, 취소하시려면 '취소'를 누르세요.`;

            if (!confirm(confirmationMessage)) {
                showMessageJjul(`${recordType} 기록 전체 삭제가 취소되었습니다.`, 'info', 3000);
                return;
            }

            // (선택적) 추가적인 안전 장치
            // const safetyCheck = prompt(`데이터를 완전히 삭제하려면 "${recordType} 전체 삭제"라고 정확히 입력해주세요.`);
            // if (safetyCheck !== `${recordType} 전체 삭제`) {
            //     showMessageJjul('입력이 일치하지 않아 삭제가 취소되었습니다.', 'info', 3000);
            //     return;
            // }

            showMessageJjul(`모든 ${recordType} 기록 삭제 중...`, 'info');

            try {
                const response = await fetch('/api/jjul-times/all/', { 
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    let errorDetail = `서버 응답 오류: ${response.status}`; 
                    try {
                        const errorData = await response.json();
                        errorDetail = errorData.detail || errorDetail;
                    } catch (e) {
                        console.warn("JSON 파싱 실패 또는 서버에서 JSON 오류 응답 없음:", e);
                    }
                    throw new Error(errorDetail);
                }

                const result = await response.json(); 
                showMessageJjul(result.message || `총 ${result.deleted_count || 0}개의 ${recordType} 기록이 성공적으로 삭제되었습니다.`, 'success', 4000);
                
                if (typeof loadJjulSessions === 'function') {
                    loadJjulSessions(); 
                } else {
                    console.warn("loadJjulSessions 함수가 정의되지 않아 목록을 새로고침할 수 없습니다. 데이터는 삭제되었을 수 있습니다.");
                    const jjulTableBody = document.getElementById('jjulSessionsTable')?.getElementsByTagName('tbody')[0];
                    if (jjulTableBody) {
                        const colspan = document.getElementById('jjulSessionsTable')?.getElementsByTagName('thead')[0]?.rows[0]?.cells.length || 8;
                        jjulTableBody.innerHTML = `<tr><td colspan="${colspan}" style="text-align:center;">데이터가 삭제되었습니다. 목록을 다시 불러오려면 페이지를 새로고침하거나 '조회' 기능을 사용하세요.</td></tr>`;
                    }
                }

            } catch (error) {
                console.error(`전체 ${recordType} 기록 삭제 중 오류 발생:`, error);
                showMessageJjul(`오류: ${error.message}`, 'error', 5000);
            }
        }

        /**
         * 사용자에게 메시지를 표시하는 함수입니다.
         * @param {string} message - 표시할 메시지 내용
         * @param {string} type - 메시지 종류 ('info', 'success', 'error')
         * @param {number} [duration=0] - 메시지 자동 사라짐 시간 (ms 단위, 0이면 자동 사라짐 없음)
         */
        function showMessageJjul(message, type = 'info', duration = 0) {
            const messageArea = document.getElementById('message-area-jjul');
            if (!messageArea) {
                console.warn("messageAreaJjul 요소를 찾을 수 없습니다. Message:", message);
                return;
            }
            messageArea.textContent = message;
            messageArea.className = 'message-area ' + type; 
            messageArea.style.display = message ? 'block' : 'none';

            if (duration > 0) {
                setTimeout(() => {
                    if (messageArea.textContent === message) { // 메시지가 바뀌지 않았을 경우에만 숨김
                        messageArea.style.display = 'none';
                    }
                }, duration);
            }
        }

        function resetJjulForm(resetToStage1 = true) {
            if (!jjulForm) return; jjulForm.reset();
            if (sessionDateFlatpickrInstanceJjul) { sessionDateFlatpickrInstanceJjul.setDate(new Date().toISOString().split('T')[0], false); }
            if(startTimeInputJjul) startTimeInputJjul.value = ""; if(endTimeInputJjul) endTimeInputJjul.value = "";
            if(initialConsumableItemsContainerJjul) initialConsumableItemsContainerJjul.innerHTML = '';
            if(rareItemsContainerJjul) rareItemsContainerJjul.innerHTML = '';
            if(consumableItemsContainerJjul) consumableItemsContainerJjul.innerHTML = '';
            tempInitialConsumablesJjul = [];
            if (resetToStage1 && formStage1Jjul && formStage2Jjul && startJjulBtn && finalSubmitButtonJjul && loadPreviousJjulDataBtn) {
                formStage1Jjul.style.display = 'block'; formStage1Jjul.classList.add('active');
                formStage2Jjul.style.display = 'none'; formStage2Jjul.classList.remove('active');
                startJjulBtn.style.display = 'inline-block'; 
                finalSubmitButtonJjul.style.display = 'none';
                loadPreviousJjulDataBtn.style.display = 'inline-block';
            }
            showMessageJjul(''); // Clear any persistent messages
        }
    </script>
</body>
</html>